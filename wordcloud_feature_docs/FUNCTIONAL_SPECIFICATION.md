# 日次ワードクラウド機能 - 機能仕様書

## 📋 機能概要

日次ワードクラウド機能は、Market News Projectで収集した市場ニュース記事から重要キーワードを抽出し、視覚的に表現するワードクラウドを自動生成する機能です。

---

## 🎯 主要機能一覧

### 1. 基本機能

#### 1.1 日次ワードクラウド自動生成
- **機能ID**: F001
- **概要**: 24時間以内に収集された記事から自動的にワードクラウドを生成
- **入力**: スクレイピングされた記事データ
- **出力**: base64エンコードされた画像データ
- **実行タイミング**: 各スクレイピングセッション完了後

#### 1.2 日本語テキスト処理
- **機能ID**: F002  
- **概要**: 日本語記事の形態素解析と意味のある単語の抽出
- **処理内容**:
  - MeCabによる形態素解析
  - 品詞フィルタリング（名詞、動詞、形容詞）
  - ストップワード除去
  - 最小文字数フィルタ

#### 1.3 金融重要語句の重み付け
- **機能ID**: F003
- **概要**: 金融・経済関連の重要語句を強調表示
- **重み付け対象語句**:
  - 中央銀行名: 日銀(3.2), FRB(3.0), ECB(2.5)
  - 経済指標: GDP(2.5), インフレ(2.8), 金利(3.0)
  - 市場用語: 株価(2.8), 円安(2.5), ドル(2.3)

#### 1.4 HTML統合表示
- **機能ID**: F004
- **概要**: 生成されたワードクラウドをWebページに埋め込み表示
- **表示位置**: 記事リストの上部
- **画像サイズ**: 800x400px（レスポンシブ対応）

---

## 🎨 視覚化機能詳細

### 2. 画像生成機能

#### 2.1 配色システム
```
色彩テーマ: プロフェッショナル金融
- プライマリ: 青系 (#1E3A8A, #3B82F6, #60A5FA)
- ポジティブ: 緑系 (#059669, #10B981, #34D399) 
- ネガティブ: 赤系 (#DC2626, #EF4444, #F87171)
- ニュートラル: グレー系 (#6B7280, #9CA3AF, #D1D5DB)
```

#### 2.2 フォントシステム
- **日本語フォント**: Noto Sans CJK Regular
- **最大フォントサイズ**: 100px
- **最小フォントサイズ**: 20px
- **フォントスケーリング**: 頻度に比例した相対サイズ

#### 2.3 レイアウト設定
- **画像サイズ**: 800x400px
- **背景**: 透明（rgba(0,0,0,0)）
- **最大単語数**: 100語
- **単語間隔**: 自動最適化

---

## 📊 データ処理機能

### 3. テキスト解析機能

#### 3.1 記事データ取得
```python
# 対象データ
- 記事タイトル (title)
- 記事本文 (body) 
- AI要約文 (summary)
- 情報源 (source)
- 公開日時 (published_at)
```

#### 3.2 前処理パイプライン
```
1. テキスト結合 → 2. 形態素解析 → 3. 品詞フィルタ → 
4. ストップワード除去 → 5. 正規化 → 6. 頻度計算
```

#### 3.3 単語フィルタリング
- **品詞指定**: 名詞(一般/固有名詞/サ変接続)、動詞(自立)、形容詞(自立)
- **除外品詞**: 助詞、助動詞、接続詞、感動詞、記号
- **文字数制限**: 2文字以上
- **除外パターン**: 数字のみ、1文字英字、句読点

---

## 🗄️ データ管理機能

### 4. 永続化機能

#### 4.1 データベース保存
```sql
-- 保存データ構造
wordcloud_data:
- image_base64: TEXT (画像データ)
- session_id: INTEGER (セッションID)  
- total_articles: INTEGER (対象記事数)
- generation_time_ms: INTEGER (生成時間)

wordcloud_frequencies:
- word: VARCHAR(100) (単語)
- frequency: INTEGER (出現頻度)
- weight_applied: REAL (適用重み)
```

#### 4.2 履歴管理
- **保持期間**: 30日間
- **自動削除**: 古いデータの定期クリーンアップ
- **インデックス**: 生成日時、セッションIDでインデックス作成

---

## 🌐 Web統合機能

### 5. UI/UX機能

#### 5.1 HTML テンプレート
```html
<!-- セクション構成 -->
<section class="wordcloud-section">
  <header>タイトル + メタデータ</header>
  <main>ワードクラウド画像</main>
  <footer>統計情報</footer>
</section>
```

#### 5.2 レスポンシブ対応
- **デスクトップ**: 800x400px フル表示
- **タブレット**: 600x300px スケール調整
- **モバイル**: 100%幅 高さ自動調整

#### 5.3 アクセシビリティ
- **代替テキスト**: 「市場キーワード分析 - N個のキーワード」
- **色覚対応**: ColorBrewer準拠の配色
- **キーボード操作**: フォーカス対応

---

## 🔄 処理フロー機能

### 6. ワークフロー管理

#### 6.1 メイン処理フロー
```
スクレイピング完了 → 記事データ取得 → テキスト前処理 →
単語頻度計算 → 重み付け適用 → 画像生成 → 
データベース保存 → HTML更新 → 完了
```

#### 6.2 エラーハンドリング
- **処理継続**: 非クリティカルエラーは警告ログでスキップ
- **フォールバック**: 生成失敗時はデフォルト画像表示
- **リトライ**: 一時的なエラーは3回まで再試行

#### 6.3 パフォーマンス監視
- **生成時間**: 5秒以内の目標時間監視
- **メモリ使用量**: 500MB以内の制限監視  
- **ファイルサイズ**: 500KB以内の画像サイズ監視

---

## ⚙️ 設定管理機能

### 7. 設定カスタマイズ

#### 7.1 画像設定
```python
# カスタマイズ可能項目
- 画像サイズ (width, height)
- 背景色 (background_color)  
- 最大単語数 (max_words)
- フォントサイズ範囲 (min/max_font_size)
```

#### 7.2 処理設定
```python
# 調整可能パラメータ
- 最小出現頻度 (min_word_frequency: 2)
- スケーリング係数 (relative_scaling: 0.5)
- MeCab辞書パス (mecab_dicdir)
- ストップワードファイル (stopwords_file)
```

#### 7.3 重み設定
```python
# 金融重要語句の重み調整
financial_weights = {
    "日銀": 3.2,    # 最高重要度
    "FRB": 3.0,     # 高重要度
    "GDP": 2.5,     # 中重要度
    # ...カスタマイズ可能
}
```

---

## 🧪 品質保証機能

### 8. 検証・テスト機能

#### 8.1 入力検証
- **記事データ**: 必須フィールドの存在確認
- **テキスト長**: 最小文字数(100文字)の確認
- **文字エンコーディング**: UTF-8エンコード確認

#### 8.2 出力検証
- **画像生成**: base64データの正当性確認
- **ファイルサイズ**: 制限値以内の確認
- **単語数**: 最小表示単語数(10語)の確認

#### 8.3 パフォーマンステスト
- **生成時間測定**: 各処理段階の時間計測
- **メモリ監視**: ピーク使用量の記録
- **品質スコア**: 生成結果の品質評価

---

## 📈 運用監視機能

### 9. ロギング・監視

#### 9.1 処理ログ
```python
# ログレベル別出力
INFO:  "ワードクラウド生成開始 - 記事数: N件"
DEBUG: "形態素解析完了 - 単語数: N語"  
WARN:  "重要語句が見つかりません"
ERROR: "画像生成に失敗しました"
```

#### 9.2 統計情報
- **生成成功率**: 日次の成功/失敗比率
- **平均生成時間**: パフォーマンス監視
- **人気キーワード**: 頻出語句ランキング

#### 9.3 アラート機能  
- **生成失敗**: 3回連続失敗時にアラート
- **処理時間超過**: 10秒超過時に警告
- **メモリ不足**: 使用量80%超過時に通知

---

## 🔧 保守・運用機能

### 10. メンテナンス機能

#### 10.1 データクリーンアップ
- **自動削除**: 30日経過したワードクラウドデータ
- **手動削除**: 管理コマンドによる任意期間削除
- **圧縮機能**: 古いデータの画像圧縮

#### 10.2 設定更新
- **ホットリロード**: 再起動不要の設定変更
- **バックアップ**: 設定変更前の自動バックアップ
- **バリデーション**: 設定値の妥当性チェック

#### 10.3 診断機能
- **ヘルスチェック**: 依存ライブラリの動作確認
- **接続テスト**: データベース、フォントファイルの確認
- **パフォーマンステスト**: ベンチマーク実行

---

## 🚀 拡張機能（将来実装予定）

### 11. エンハンスメント

#### 11.1 インタラクティブ機能
- **単語クリック**: クリックした単語で記事フィルタリング
- **ズーム機能**: 画像の拡大表示
- **単語詳細**: ホバーで出現頻度表示

#### 11.2 比較機能  
- **時系列比較**: 昨日vs今日のワードクラウド
- **感情別表示**: ポジティブ/ネガティブ分離表示
- **ソース別表示**: Reuters/Bloomberg別表示

#### 11.3 エクスポート機能
- **画像ダウンロード**: PNG/SVG/PDF形式
- **データエクスポート**: CSV/JSON形式の単語リスト
- **レポート生成**: 自動分析レポート作成

---

## 📊 機能測定指標

### 12. KPI・メトリクス

#### 12.1 技術指標
- **生成成功率**: 99%以上
- **平均生成時間**: 3秒以下
- **画像品質スコア**: 自動評価80点以上

#### 12.2 ユーザビリティ指標
- **セクション閲覧率**: 80%以上のユーザーが閲覧
- **滞在時間**: ワードクラウド表示で20%延長
- **モバイル表示**: スコア90以上

#### 12.3 運用指標
- **システム稼働率**: 99%以上
- **エラー発生率**: 1%未満
- **リソース使用率**: CPU 50%、メモリ 70%以内

---

## 🔒 セキュリティ・信頼性

### 13. セキュリティ機能

#### 13.1 データ保護
- **機密情報**: 記事本文の適切な匿名化
- **アクセス制御**: データベース読み取り専用権限
- **ログ保護**: 個人情報を含まないログ出力

#### 13.2 エラー対策
- **入力サニタイゼーション**: 悪意ある入力の無害化
- **リソース制限**: DoS攻撃対策の処理制限
- **フォールバック**: 機能停止を回避する代替処理

#### 13.3 監査機能
- **操作ログ**: 全ての生成処理をログ記録
- **変更履歴**: 設定変更の履歴管理
- **整合性チェック**: データの整合性定期確認