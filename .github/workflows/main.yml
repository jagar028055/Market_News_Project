name: Market News Scraper

on:
  schedule:
    - cron: '0 22 * * *' # JST 7æ™‚
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
  push:
    paths:
      - '.github/workflows/main.yml' # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ›´æ–°æ™‚ã®ã¿pushãƒˆãƒªã‚¬ãƒ¼
    inputs:
      enable_podcast:
        description: 'Enable podcast generation'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  # ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
  check-tests:
    runs-on: ubuntu-latest
    outputs:
      tests-passed: ${{ steps.check-test-results.outputs.passed }}
    steps:
    - name: Check if tests are required
      id: check-test-results
      run: |
        # masterãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã€ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèª
        if [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "Tests verification required for deployment"
          echo "passed=required" >> $GITHUB_OUTPUT
        else
          echo "Tests verification not required for feature branches"
          echo "passed=skipped" >> $GITHUB_OUTPUT
        fi

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: check-tests
    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
      issues: write   # å¤±æ•—æ™‚Issueä½œæˆç”¨

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify test results for master branch deployment
      if: github.ref == 'refs/heads/master'
      run: |
        echo "ğŸ§ª ãƒã‚¹ã‚¿ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒ†ã‚¹ãƒˆç¢ºèª"
        echo "æœ€æ–°ã®ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª..."
        
        # æœ€æ–°ã®ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªï¼ˆGitHub CLIä½¿ç”¨ï¼‰
        if command -v gh >/dev/null 2>&1; then
          echo "GitHub CLIã§ãƒ†ã‚¹ãƒˆçµæœã‚’ç¢ºèªä¸­..."
          LATEST_TEST_RUN=$(gh run list --workflow=test.yml --limit=1 --json conclusion,status | jq -r '.[0].conclusion')
          if [ "$LATEST_TEST_RUN" = "success" ]; then
            echo "âœ… æœ€æ–°ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒæˆåŠŸ: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¶šè¡Œ"
          elif [ "$LATEST_TEST_RUN" = "failure" ]; then
            echo "âŒ æœ€æ–°ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¤±æ•—: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢"
            exit 1
          else
            echo "âš ï¸ ãƒ†ã‚¹ãƒˆçµæœãŒä¸æ˜ã¾ãŸã¯å®Ÿè¡Œä¸­: è­¦å‘Šè¡¨ç¤ºã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ç¶šè¡Œ"
          fi
        else
          echo "âš ï¸ GitHub CLIæœªåˆ©ç”¨: ãƒ†ã‚¹ãƒˆç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ç¶šè¡Œ"
        fi

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # è»½é‡åŒ–ã•ã‚ŒãŸrequirements.txtã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆç´„50%é«˜é€ŸåŒ–ï¼‰
        pip install -r requirements.txt

    - name: Clean up previous run artifacts
      run: |
        # æ—¢å­˜ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®Œå…¨å‰Šé™¤
        rm -f index.html
        rm -rf public/
        # ä¸€æ™‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
        rm -f *.html
        rm -rf __pycache__/
        echo "Clean up completed - all previous artifacts removed"

    - name: Install system dependencies
      run: |
        # MeCabï¼ˆæ—¥æœ¬èªå½¢æ…‹ç´ è§£æï¼‰ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« - ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ç”¨
        sudo apt-get update
        sudo apt-get install -y mecab mecab-ipadic-utf8 libmecab-dev
        echo "âœ… MeCab installation completed"
        mecab --version
        echo "ğŸ“¦ FFmpegã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½ã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰"

    - name: Install Japanese fonts for WordCloud
      run: |
        # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆï¼ˆIPAç³» + Noto CJKï¼‰ã‚’å°å…¥ã—ã¦æ–‡å­—åŒ–ã‘ã‚’é˜²æ­¢
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        echo "âœ… Japanese fonts installation completed"
        # ãƒ•ã‚©ãƒ³ãƒˆç¢ºèªï¼ˆç°¡æ½”ç‰ˆï¼‰
        fc-list :lang=ja | head -10 || echo "Japanese fonts installed"

    - name: Enhanced System Health Check
      run: |
        echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        echo "======================================="
        
        # Pythonç’°å¢ƒè©³ç´°ç¢ºèª
        echo "ğŸ Pythonç’°å¢ƒæƒ…å ±:"
        python --version
        which python
        python -c "import sys; print(f'å®Ÿè¡Œãƒ‘ã‚¹: {sys.executable}')"
        python -c "import sys; print(f'ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¤œç´¢ãƒ‘ã‚¹: {sys.path[:3]}...')"
        
        # å¿…é ˆä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ
        echo ""
        echo "ğŸ“¦ å¿…é ˆä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ:"
        python -c "
        import sys
        
        # åŸºæœ¬ä¾å­˜é–¢ä¿‚
        modules = {
            'requests': 'HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ',
            'beautifulsoup4': 'HTMLãƒ‘ãƒ¼ã‚µãƒ¼',
            'selenium': 'ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–',
            'pandas': 'ãƒ‡ãƒ¼ã‚¿å‡¦ç†',
            'google-auth': 'Googleèªè¨¼',
            'google-api-python-client': 'Google API',
        }
        
        failed = []
        for module, desc in modules.items():
            try:
                if module == 'beautifulsoup4':
                    import bs4
                elif module == 'google-auth':
                    import google.auth
                elif module == 'google-api-python-client':
                    import googleapiclient
                else:
                    __import__(module)
                print(f'  âœ… {module}: OK ({desc})')
            except ImportError as e:
                print(f'  âŒ {module}: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•— - {desc}')
                failed.append(module)
        
        if failed:
            print(f'\\nâš ï¸ å¤±æ•—ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: {\", \".join(failed)}')
            sys.exit(1)
        else:
            print('\\nâœ… ã™ã¹ã¦ã®åŸºæœ¬ä¾å­˜é–¢ä¿‚: OK')
        "
        
        # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ
        echo ""
        echo "ğŸŒ ä¸»è¦ã‚µã‚¤ãƒˆæ¥ç¶šãƒ†ã‚¹ãƒˆ:"
        sites=(
          "https://www.reuters.com"
          "https://www.bloomberg.com" 
          "https://generativelanguage.googleapis.com"
          "https://docs.googleapis.com"
          "https://accounts.google.com"
        )
        
        for site in "${sites[@]}"; do
          if curl -I -s --max-time 10 "$site" | head -1 | grep -q "200\|301\|302"; then
            echo "  âœ… $site: æ¥ç¶šæˆåŠŸ"
          else
            echo "  âš ï¸ $site: æ¥ç¶šå•é¡Œã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ"
          fi
        done
        
        # ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ç¢ºèª
        echo ""
        echo "ğŸ’¾ ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±:"
        echo "  ãƒ¡ãƒ¢ãƒª: $(free -h | grep '^Mem:' | awk '{print $2" (åˆ©ç”¨å¯èƒ½: "$7")"}')"
        echo "  ãƒ‡ã‚£ã‚¹ã‚¯: $(df -h / | tail -1 | awk '{print "ä½¿ç”¨é‡ "$3"/"$2" ("$5" ä½¿ç”¨ä¸­)"}')"
        echo "  CPU: $(nproc)ã‚³ã‚¢"
        
        echo "======================================="
        echo "ğŸ¥ ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Audio Dependencies Health Check
      if: env.ENABLE_PODCAST_GENERATION == 'true' || github.event.inputs.enable_podcast == 'true'
      run: |
        echo "ğŸ™ï¸ éŸ³å£°æ©Ÿèƒ½ä¾å­˜é–¢ä¿‚ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
        echo "============================================"
        
        # éŸ³å£°å‡¦ç†é–¢é€£ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ
        python -c "
        import sys
        
        audio_modules = {
            'pydub': 'éŸ³å£°å‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒª',
            'google.cloud.texttospeech': 'Google Cloud TTS',
            'feedgen': 'RSSãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆ',
            'yaml': 'YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†'
        }
        
        failed = []
        for module, desc in audio_modules.items():
            try:
                __import__(module)
                print(f'  âœ… {module}: OK ({desc})')
            except ImportError as e:
                print(f'  âŒ {module}: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•— - {desc}')
                print(f'      ã‚¨ãƒ©ãƒ¼è©³ç´°: {e}')
                failed.append(module)
        
        if failed:
            print(f'\nâš ï¸ å¤±æ•—ã—ãŸéŸ³å£°é–¢é€£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: {", ".join(failed)}')
            print('\nğŸ“ è§£æ±ºæ–¹æ³•:')
            for module in failed:
                if module == 'pydub':
                    print('  pip install pydub>=0.25.1')
                elif 'google.cloud' in module:
                    print('  pip install google-cloud-texttospeech>=2.16.0')
                elif module == 'feedgen':
                    print('  pip install feedgen>=0.9.0')
                elif module == 'yaml':
                    print('  pip install PyYAML>=6.0')
        else:
            print('\nâœ… ã™ã¹ã¦ã®éŸ³å£°é–¢é€£ä¾å­˜é–¢ä¿‚: OK')
        "
        
        # FFmpegç¢ºèª
        echo ""
        echo "ğŸ”§ FFmpegç¢ºèª:"
        if command -v ffmpeg >/dev/null 2>&1; then
          echo "  âœ… FFmpeg: $(ffmpeg -version | head -1)"
        else
          echo "  âŒ FFmpeg: æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
        fi
        
        echo "============================================"
        echo "ğŸ™ï¸ éŸ³å£°æ©Ÿèƒ½ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†"

    - name: Run script
      env:
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­å®š
        ENABLE_GOOGLE_SERVICES: 'true'  # Google Serviceså‡¦ç†ã‚’ç„¡åŠ¹åŒ–ã—ã¦å®Ÿè¡Œæ™‚é–“ã‚’çŸ­ç¸®
        # Googleèªè¨¼è¨­å®š (OAuth2ã«å›ºå®š) - ç¾åœ¨ã¯ç„¡åŠ¹åŒ–
        GOOGLE_AUTH_METHOD: 'oauth2'
        GOOGLE_DRIVE_OUTPUT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_OUTPUT_FOLDER_ID }}
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        # OAuth2èªè¨¼æƒ…å ±ã®ã¿ã‚’è¨­å®šï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¤‰æ•°ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        # AIè¨­å®š
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æœ€é©åŒ–è¨­å®š
        SCRAPING_SENTIMENT_ANALYSIS_ENABLED: 'false'  # æ„Ÿæƒ…åˆ†æã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆåˆ¶å¾¡
        FORCE_DOCUMENT_GENERATION: true
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½ç”¨ç’°å¢ƒå¤‰æ•°
        ENABLE_PODCAST_GENERATION: ${{ github.event.inputs.enable_podcast || secrets.ENABLE_PODCAST_GENERATION }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        PODCAST_RSS_BASE_URL: ${{ secrets.PODCAST_RSS_BASE_URL }}
        PODCAST_AUTHOR_NAME: ${{ secrets.PODCAST_AUTHOR_NAME }}
        PODCAST_AUTHOR_EMAIL: ${{ secrets.PODCAST_AUTHOR_EMAIL }}
        PODCAST_RSS_TITLE: ${{ secrets.PODCAST_RSS_TITLE || 'ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ' }}
        PODCAST_RSS_DESCRIPTION: ${{ secrets.PODCAST_RSS_DESCRIPTION || 'AIãŒç”Ÿæˆã™ã‚‹æ¯æ—¥ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹' }}
        PODCAST_MONTHLY_COST_LIMIT: ${{ secrets.PODCAST_MONTHLY_COST_LIMIT || '10.0' }}
        PODCAST_TARGET_DURATION_MINUTES: ${{ secrets.PODCAST_TARGET_DURATION_MINUTES || '10.0' }}
        PODCAST_MAX_FILE_SIZE_MB: ${{ secrets.PODCAST_MAX_FILE_SIZE_MB || '15' }}
        # Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æºå¯¾å¿œ
        PODCAST_DATA_SOURCE: ${{ secrets.PODCAST_DATA_SOURCE || 'database' }}
        GEMINI_PODCAST_MODEL: ${{ secrets.GEMINI_PODCAST_MODEL || 'gemini-2.5-pro' }}
        PODCAST_PRODUCTION_MODE: ${{ secrets.PODCAST_PRODUCTION_MODE || 'false' }}
      timeout-minutes: 15  # 20â†’15åˆ†ã«çŸ­ç¸®ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–åŠ¹æœã«ã‚ˆã‚Šï¼‰
      run: python scripts/core/main.py

    - name: Create public directory and copy files
      run: |
        mkdir -p public
        cp index.html public/
        cp -r assets public/
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -d "podcast" ]; then
          cp -r podcast public/
        fi
        # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ï¼ˆSNSç”»åƒãƒ»noteï¼‰ã‚’Pagesã«å«ã‚ã‚‹
        if [ -d "build/social" ]; then
          mkdir -p public/social
          cp -r build/social/* public/social/
        fi
        if [ -d "build/note" ]; then
          mkdir -p public/note
          cp -r build/note/* public/note/
        fi

    - name: Upload database artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: market-news-db
        path: market_news.db
        retention-days: 2
        compression-level: 6

    - name: Deploy to GitHub Pages (master)
      if: github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒ
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'

    - name: Deploy preview to GitHub Pages (feature branches)
      if: github.ref != 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        destination_dir: previews/${{ github.ref_name }}
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'

    - name: Output preview URL
      if: success()
      run: |
        if [ "${{ github.ref }}" = "refs/heads/master" ]; then
          echo "Preview URL (master): https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          echo "Social: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/social/" >> $GITHUB_STEP_SUMMARY
          echo "Note:   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/note/" >> $GITHUB_STEP_SUMMARY
        else
          echo "Preview URL (branch): https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ github.ref_name }}/" >> $GITHUB_STEP_SUMMARY
          echo "Social: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ github.ref_name }}/social/" >> $GITHUB_STEP_SUMMARY
          echo "Note:   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/previews/${{ github.ref_name }}/note/" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Collect Error Information  
      if: failure()
      run: |
        echo "ğŸ“Š ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±åé›†"
        echo "WORKFLOW_ERROR_INFO<<EOF" >> $GITHUB_ENV
        echo "## ğŸ”´ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "**å¤±æ•—æ™‚åˆ»**: $(date -u)" >> $GITHUB_ENV
        echo "**Ubuntuç‰ˆ**: $(lsb_release -d | cut -f2)" >> $GITHUB_ENV
        echo "**Pythonè©³ç´°**: $(python --version 2>&1)" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ä¾å­˜é–¢ä¿‚" >> $GITHUB_ENV
        pip list | grep -E "(requests|beautifulsoup|selenium|google|pandas)" >> $GITHUB_ENV || echo "é–¢é€£ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã—" >> $GITHUB_ENV
        echo "" >> $GITHUB_ENV
        echo "### ğŸŒ ä¸»è¦ã‚µã‚¤ãƒˆæ¥ç¶šç¢ºèª" >> $GITHUB_ENV
        for site in "https://www.reuters.com" "https://www.bloomberg.com" "https://generativelanguage.googleapis.com"; do
          curl -I -s --max-time 5 "$site" | head -1 >> $GITHUB_ENV || echo "$site: æ¥ç¶šå¤±æ•—" >> $GITHUB_ENV
        done
        echo "EOF" >> $GITHUB_ENV

    - name: Create Issue on Failure
      if: failure() && github.event.pull_request == null
      uses: jayqi/failed-build-issue-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        title-template: "ğŸ“° ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼å¤±æ•— #${{ github.run_number }} - ${{ github.workflow }}"
        body-template: |
          ## ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—è©³ç´°æƒ…å ±
          
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${{ github.workflow }}
          **å®Ÿè¡Œç•ªå·**: #${{ github.run_number }}
          **å®Ÿè¡Œè€…**: @${{ github.actor }}
          **ãƒˆãƒªã‚¬ãƒ¼**: ${{ github.event_name }}
          **ãƒ–ãƒ©ãƒ³ãƒ**: `${{ github.ref_name }}`
          **ã‚³ãƒŸãƒƒãƒˆ**: `${{ github.sha }}` by @${{ github.event.head_commit.author.name }}
          **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}
          **å®Ÿè¡ŒID**: ${{ github.run_id }}
          
          ### ğŸ”— é‡è¦ãªãƒªãƒ³ã‚¯
          - [ğŸ“Š å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ“ ã‚³ãƒŸãƒƒãƒˆè©³ç´°](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - [ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒç¢ºèª](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }})
          
          ### ğŸ› ï¸ ç’°å¢ƒãƒ»è¨­å®šæƒ…å ±
          **ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæœ‰åŠ¹**: `${{ github.event.inputs.enable_podcast || 'false' }}`
          **Python**: Ubuntu Latest (é€šå¸¸Python 3.x)
          **OS**: ubuntu-latest
          
          ### ğŸš¨ APIèªè¨¼ãƒã‚§ãƒƒã‚¯
          **Gemini API**: ${{ env.GEMINI_API_KEY != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          **LINE Bot**: ${{ env.LINE_CHANNEL_ACCESS_TOKEN != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          **Google OAuth2**: ${{ env.GOOGLE_OAUTH2_CLIENT_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          
          ### ğŸ¯ è©³ç´°è¨ºæ–­ãƒ»å¯¾å¿œæ‰‹é †
          
          #### 1. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç¢ºèª
          - [ ] [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª
          - [ ] å¤±æ•—ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’ç‰¹å®šï¼ˆé€šå¸¸ã¯ "Run main.py"ï¼‰
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰åŸå› ã‚’ç‰¹å®š
          
          #### 2. ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ»APIç¢ºèª
          - [ ] å¯¾è±¡ã‚µã‚¤ãƒˆï¼ˆReutersã€Bloombergï¼‰ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
          - [ ] Gemini APIåˆ©ç”¨åˆ¶é™ãƒ»èªè¨¼ç¢ºèª
          - [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚„IPåˆ¶é™ã®å¯èƒ½æ€§ç¢ºèª
          - [ ] ã‚µã‚¤ãƒˆæ§‹é€ å¤‰æ›´ã®å¯èƒ½æ€§ç¢ºèª
          
          #### 3. ä¾å­˜é–¢ä¿‚ãƒ»ç’°å¢ƒç¢ºèª  
          - [ ] `requirements.txt` ã®ä¾å­˜é–¢ä¿‚ãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          - [ ] Selenium WebDriver ã®å‹•ä½œç¢ºèª
          - [ ] ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ»DNSè§£æ±ºç¢ºèª
          
          #### 4. ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œ
          ```bash
          # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ
          python main.py
          
          # æ¥ç¶šãƒ†ã‚¹ãƒˆ
          python -c "import requests; print(requests.get('https://httpbin.org/get').status_code)"
          
          # ç‰¹å®šã‚µã‚¤ãƒˆãƒ†ã‚¹ãƒˆ
          curl -I https://www.reuters.com
          curl -I https://www.bloomberg.com
          
          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ‰‹å‹•å†å®Ÿè¡Œ
          gh workflow run "Market News Scraper"
          ```
          
          ### ğŸ” ã‚ˆãã‚ã‚‹å¤±æ•—åŸå› 
          
          | ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ— | åŸå›  | è§£æ±ºæ–¹æ³• |
          |------------|------|----------|
          | **ScrapingError** | ã‚µã‚¤ãƒˆæ§‹é€ å¤‰æ›´ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç¢ºèªãƒ»é–“éš”èª¿æ•´ |
          | **APIError** | Geminiåˆ¶é™ãƒ»èªè¨¼ | APIè¨­å®šãƒ»åˆ¶é™ç¢ºèª |
          | **TimeoutError** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å•é¡Œ | å†å®Ÿè¡Œãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆèª¿æ•´ |
          | **ImportError** | ä¾å­˜é–¢ä¿‚ä¸è¶³ | requirements.txtç¢ºèª |
          | **SeleniumError** | WebDriverå•é¡Œ | ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹è¨­å®šç¢ºèª |
          
          ### ğŸ“ ç·Šæ€¥æ™‚å¯¾å¿œ
          
          **å³åº§ã«å¯¾å¿œãŒå¿…è¦ãªå ´åˆ:**
          1. æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†å®Ÿè¡Œ
          2. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‹ã‚‰å…·ä½“çš„ãªåŸå› ç‰¹å®š  
          3. å¿…è¦ã«å¿œã˜ã¦ä¾å­˜é–¢ä¿‚æ›´æ–°
          4. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ä¿®æ­£é©ç”¨
          
          ${{ env.WORKFLOW_ERROR_INFO }}
          
          ---
          
          **ğŸ¤– è‡ªå‹•ç”Ÿæˆæ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}  
          **ğŸ“Š ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          **ğŸ”§ è§£æ±ºå¾Œ**: ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„
        label-name: "CI/CD"
        always-create-new-issue: false
