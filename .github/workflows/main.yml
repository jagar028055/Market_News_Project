name: Market News Scraper

on:
  schedule:
    - cron: '0 22 * * *' # JST 7æ™‚
    - cron: '0 4,14 * * *' # JST 13æ™‚, 23æ™‚
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      enable_podcast:
        description: 'Enable podcast generation'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
      issues: write   # å¤±æ•—æ™‚Issueä½œæˆç”¨

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Clean up previous run artifacts
      run: |
        # æ—¢å­˜ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å®Œå…¨å‰Šé™¤
        rm -f index.html
        rm -rf public/
        # ä¸€æ™‚çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å‰Šé™¤
        rm -f *.html
        rm -rf __pycache__/
        echo "Clean up completed - all previous artifacts removed"

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg mecab mecab-ipadic-utf8 libmecab-dev
        echo "MeCab installation completed"
        mecab --version

    - name: Install Japanese fonts for WordCloud
      run: |
        sudo apt-get install -y fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho
        echo "Japanese fonts installation completed"
        # ãƒ•ã‚©ãƒ³ãƒˆç¢ºèª
        fc-list | grep -i "noto\|ipa" | head -5

    - name: Run script
      env:
        # Googleèªè¨¼è¨­å®š (OAuth2ã«å›ºå®š)
        GOOGLE_AUTH_METHOD: 'oauth2'
        GOOGLE_DRIVE_OUTPUT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_OUTPUT_FOLDER_ID }}
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        # OAuth2èªè¨¼æƒ…å ±ã®ã¿ã‚’è¨­å®šï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¤‰æ•°ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        # AIè¨­å®š
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆåˆ¶å¾¡
        FORCE_DOCUMENT_GENERATION: true
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½ç”¨ç’°å¢ƒå¤‰æ•°
        ENABLE_PODCAST_GENERATION: ${{ github.event.inputs.enable_podcast || secrets.ENABLE_PODCAST_GENERATION }}
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        PODCAST_RSS_BASE_URL: ${{ secrets.PODCAST_RSS_BASE_URL }}
        PODCAST_AUTHOR_NAME: ${{ secrets.PODCAST_AUTHOR_NAME }}
        PODCAST_AUTHOR_EMAIL: ${{ secrets.PODCAST_AUTHOR_EMAIL }}
        PODCAST_RSS_TITLE: ${{ secrets.PODCAST_RSS_TITLE || 'ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ' }}
        PODCAST_RSS_DESCRIPTION: ${{ secrets.PODCAST_RSS_DESCRIPTION || 'AIãŒç”Ÿæˆã™ã‚‹æ¯æ—¥ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹' }}
        PODCAST_MONTHLY_COST_LIMIT: ${{ secrets.PODCAST_MONTHLY_COST_LIMIT || '10.0' }}
        PODCAST_TARGET_DURATION_MINUTES: ${{ secrets.PODCAST_TARGET_DURATION_MINUTES || '10.0' }}
        PODCAST_MAX_FILE_SIZE_MB: ${{ secrets.PODCAST_MAX_FILE_SIZE_MB || '15' }}
      timeout-minutes: 20
      run: python main.py

    - name: Create public directory and copy files
      run: |
        mkdir -p public
        cp index.html public/
        cp -r assets public/
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -d "podcast" ]; then
          cp -r podcast public/
        fi

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒ
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'

    - name: Create Issue on Failure
      if: failure() && github.event.pull_request == null
      uses: jayqi/failed-build-issue-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        title-template: "ğŸ“° ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼å¤±æ•— - {{date}}"
        body-template: |
          ## ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—è©³ç´°
          
          **å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: Market News Scraper
          **å®Ÿè¡Œè€…**: @{{actor}}
          **ãƒ–ãƒ©ãƒ³ãƒ**: `{{ref}}`
          **ã‚³ãƒŸãƒƒãƒˆ**: {{sha}} by @{{author}}
          **å®Ÿè¡Œæ™‚åˆ»**: {{date}}
          **å®Ÿè¡ŒID**: {{runId}}
          
          ### ğŸ”— ãƒªãƒ³ã‚¯
          - [å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ]({{workflowRunUrl}})
          - [ã‚³ãƒŸãƒƒãƒˆè©³ç´°]({{commitUrl}})
          
          ### ğŸ¯ æ¨å¥¨å¯¾å¿œ
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
          - [ ] ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚µã‚¤ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
          - [ ] Gemini APIåˆ¶é™ãƒ»èªè¨¼æƒ…å ±ç¢ºèª
          - [ ] ä¾å­˜é–¢ä¿‚ã®å•é¡ŒãŒãªã„ã‹ç¢ºèª
          - [ ] LINE Botè¨­å®šç¢ºèªï¼ˆé€šçŸ¥æ©Ÿèƒ½ä½¿ç”¨æ™‚ï¼‰
          
          ### ğŸ”§ ç·Šæ€¥å¯¾å¿œã‚³ãƒãƒ³ãƒ‰
          ```bash
          # æ‰‹å‹•ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†å®Ÿè¡Œ
          gh workflow run "Market News Scraper" --ref {{ref}}
          
          # ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          python main.py
          
          # ç‰¹å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ
          python -c "import requests; print(requests.get('https://httpbin.org/get').status_code)"
          ```
          
          ### ğŸš¨ ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼åŸå› 
          - **ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼**: å¯¾è±¡ã‚µã‚¤ãƒˆã®æ§‹é€ å¤‰æ›´ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™
          - **APIåˆ¶é™**: Gemini APIã®åˆ©ç”¨åˆ¶é™è¶…é
          - **èªè¨¼ã‚¨ãƒ©ãƒ¼**: ç’°å¢ƒå¤‰æ•°ã®è¨­å®šä¸å‚™
          - **ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼**: requirements.txtã®ä¸è¶³
          
          ---
          ã“ã®Issueã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å•é¡ŒãŒè§£æ±ºã—ãŸã‚‰Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ãã ã•ã„ã€‚
        label-name: "CI/CD"
        always-create-new-issue: false
