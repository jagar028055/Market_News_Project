name: 7-Prompt Pattern Comparison Test

on:
  workflow_dispatch:
    inputs:
      data_source:
        description: 'Data source (ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹)'
        required: true
        default: 'database'
        type: choice
        options:
        - 'database'
        - 'google_document'
      target_articles:
        description: 'Number of target articles (å¯¾è±¡è¨˜äº‹æ•°)'
        required: true
        default: '15'
        type: string
      skip_audio:
        description: 'Skip audio generation (éŸ³å£°ç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—)'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      generate_gdoc:
        description: 'Generate Google Document report (Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ)'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  prompt-pattern-comparison:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        echo "System dependencies installed"

    - name: Create directories
      run: |
        mkdir -p logs
        mkdir -p prompt_comparison_results
        echo "Directories created"

    - name: 7-Prompt Pattern Comparison Test
      env:
        # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š
        PODCAST_DATA_SOURCE: ${{ github.event.inputs.data_source }}
        COMPARISON_TARGET_ARTICLES: ${{ github.event.inputs.target_articles }}
        
        # Googleèªè¨¼è¨­å®šï¼ˆGoogleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‡ºåŠ›ç”¨ï¼‰
        GOOGLE_AUTH_METHOD: 'oauth2'
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        
        # AIè¨­å®š
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_PODCAST_MODEL: 'gemini-2.5-pro'
        
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š
        PODCAST_PRODUCTION_MODE: 'false'
        PODCAST_TARGET_DURATION_MINUTES: '10.0'
        PODCAST_TARGET_SCRIPT_CHARS: '2700'
        ENABLE_PODCAST_GENERATION: ${{ github.event.inputs.skip_audio == 'false' }}
        
        # æ¯”è¼ƒã‚·ã‚¹ãƒ†ãƒ è¨­å®š
        SKIP_AUDIO_GENERATION: ${{ github.event.inputs.skip_audio }}
        GENERATE_GOOGLE_DOCUMENT: ${{ github.event.inputs.generate_gdoc }}
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
      run: |
        echo "ğŸ” 7ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€æ‹¬æ¯”è¼ƒãƒ†ã‚¹ãƒˆé–‹å§‹"
        echo "ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${{ github.event.inputs.data_source }}"
        echo "å¯¾è±¡è¨˜äº‹æ•°: ${{ github.event.inputs.target_articles }}"
        echo "éŸ³å£°ç”Ÿæˆã‚¹ã‚­ãƒƒãƒ—: ${{ github.event.inputs.skip_audio }}"
        echo "Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ: ${{ github.event.inputs.generate_gdoc }}"
        echo ""
        
        # æ¯”è¼ƒã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œ
        python prompt_pattern_comparison_runner.py

    - name: Upload comparison results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: prompt-comparison-results-${{ github.run_number }}
        path: |
          prompt_comparison_results/*.json
          logs/*.log
          logs/*.txt
        retention-days: 30

    - name: Parse comparison results
      if: always()
      id: parse_results
      run: |
        echo "Parsing comparison results..."
        
        # æœ€æ–°ã®æ¯”è¼ƒçµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        LATEST_RESULT=$(ls -t prompt_comparison_results/*.json 2>/dev/null | head -n 1 || echo "")
        
        if [ -n "$LATEST_RESULT" ] && [ -f "$LATEST_RESULT" ]; then
          echo "Found result file: $LATEST_RESULT"
          
          # JSONã‹ã‚‰ä¸»è¦ãªçµæœã‚’æŠ½å‡º
          COMPARISON_ID=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); print(data.get('comparison_id', 'N/A'))")
          TOTAL_TIME=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); print(f\"{data.get('total_execution_time_seconds', 0):.1f}\")")
          ARTICLES_COUNT=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); print(data.get('articles_metadata', {}).get('total_articles', 0))")
          
          # æˆåŠŸãƒ»å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³æ•°
          SUCCESSFUL_PATTERNS=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); analysis=data.get('comparison_results', {}).get('comparison_analysis', {}); print(analysis.get('successful_patterns', 0))")
          FAILED_PATTERNS=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); analysis=data.get('comparison_results', {}).get('comparison_analysis', {}); print(analysis.get('failed_patterns', 0))")
          
          # æœ€å„ªç§€ãƒ‘ã‚¿ãƒ¼ãƒ³
          BEST_PATTERN=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); analysis=data.get('comparison_results', {}).get('comparison_analysis', {}); best=analysis.get('best_pattern', {}); print(best.get('pattern', 'N/A'))")
          BEST_SCORE=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); analysis=data.get('comparison_results', {}).get('comparison_analysis', {}); best=analysis.get('best_pattern', {}); print(f\"{best.get('score', 0):.3f}\")")
          
          # Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçµæœ
          GDOC_URL=$(python -c "import json; data=json.load(open('$LATEST_RESULT')); gdoc=data.get('google_document', {}); print(gdoc.get('document_url', 'N/A'))")
          
          # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "comparison_id=$COMPARISON_ID" >> $GITHUB_OUTPUT
          echo "total_time=$TOTAL_TIME" >> $GITHUB_OUTPUT
          echo "articles_count=$ARTICLES_COUNT" >> $GITHUB_OUTPUT
          echo "successful_patterns=$SUCCESSFUL_PATTERNS" >> $GITHUB_OUTPUT
          echo "failed_patterns=$FAILED_PATTERNS" >> $GITHUB_OUTPUT
          echo "best_pattern=$BEST_PATTERN" >> $GITHUB_OUTPUT
          echo "best_score=$BEST_SCORE" >> $GITHUB_OUTPUT
          echo "gdoc_url=$GDOC_URL" >> $GITHUB_OUTPUT
          echo "has_results=true" >> $GITHUB_OUTPUT
          
        else
          echo "No comparison results found"
          echo "has_results=false" >> $GITHUB_OUTPUT
        fi

    - name: Create test results summary
      if: always()
      run: |
        echo "## ğŸ” 7ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€æ‹¬æ¯”è¼ƒãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å®Ÿè¡Œè¨­å®š
        echo "### ğŸ“‹ å®Ÿè¡Œè¨­å®š" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å¯¾è±¡è¨˜äº‹æ•°**: ${{ github.event.inputs.target_articles }}è¨˜äº‹" >> $GITHUB_STEP_SUMMARY
        echo "- **éŸ³å£°ç”Ÿæˆ**: ${{ github.event.inputs.skip_audio == 'true' && 'ã‚¹ã‚­ãƒƒãƒ—' || 'å®Ÿè¡Œ' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ${{ github.event.inputs.generate_gdoc == 'true' && 'ç”Ÿæˆ' || 'ã‚¹ã‚­ãƒƒãƒ—' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # å®Ÿè¡Œçµæœ
        if [[ "${{ steps.parse_results.outputs.has_results }}" == "true" ]]; then
          echo "### ğŸ“Š å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¯”è¼ƒID**: ${{ steps.parse_results.outputs.comparison_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç·å®Ÿè¡Œæ™‚é–“**: ${{ steps.parse_results.outputs.total_time }}ç§’" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¾è±¡è¨˜äº‹æ•°**: ${{ steps.parse_results.outputs.articles_count }}è¨˜äº‹" >> $GITHUB_STEP_SUMMARY
          echo "- **æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³**: ${{ steps.parse_results.outputs.successful_patterns }}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³**: ${{ steps.parse_results.outputs.failed_patterns }}å€‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.parse_results.outputs.successful_patterns }}" != "0" ]]; then
            echo "### ğŸ† æœ€å„ªç§€ãƒ‘ã‚¿ãƒ¼ãƒ³" >> $GITHUB_STEP_SUMMARY
            echo "- **ãƒ‘ã‚¿ãƒ¼ãƒ³**: ${{ steps.parse_results.outputs.best_pattern }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ç·åˆã‚¹ã‚³ã‚¢**: ${{ steps.parse_results.outputs.best_score }}/1.000" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ steps.parse_results.outputs.gdoc_url }}" != "N/A" ]]; then
            echo "### ğŸ“„ Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
            echo "[ğŸ“Š è©³ç´°æ¯”è¼ƒãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º](${{ steps.parse_results.outputs.gdoc_url }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… **ãƒ†ã‚¹ãƒˆçµæœ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ†ã‚¹ãƒˆçµæœ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âŒ å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "æ¯”è¼ƒçµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªã‚¨ãƒ©ãƒ¼å†…å®¹ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ æˆæœç‰©" >> $GITHUB_STEP_SUMMARY
        if [ -d "prompt_comparison_results" ]; then
          RESULT_COUNT=$(ls -1 prompt_comparison_results/*.json 2>/dev/null | wc -l)
          echo "- æ¯”è¼ƒçµæœãƒ•ã‚¡ã‚¤ãƒ«: ${RESULT_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
        fi
        if [ -d "logs" ]; then
          LOG_COUNT=$(ls -1 logs/*.log 2>/dev/null | wc -l)
          echo "- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«: ${LOG_COUNT}å€‹" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Comment on commit
      if: always() && github.event_name == 'workflow_dispatch'
      uses: peter-evans/commit-comment@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## ğŸ” 7ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€æ‹¬æ¯”è¼ƒãƒ†ã‚¹ãƒˆçµæœ
          
          **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}
          **å¯¾è±¡è¨˜äº‹æ•°**: ${{ github.event.inputs.target_articles }}è¨˜äº‹
          **çµæœ**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
          **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼
          ${{ steps.parse_results.outputs.has_results == 'true' && format('- **æ¯”è¼ƒID**: {0}', steps.parse_results.outputs.comparison_id) || '- æ¯”è¼ƒçµæœã®å–å¾—ã«å¤±æ•—' }}
          ${{ steps.parse_results.outputs.has_results == 'true' && format('- **å®Ÿè¡Œæ™‚é–“**: {0}ç§’', steps.parse_results.outputs.total_time) || '' }}
          ${{ steps.parse_results.outputs.has_results == 'true' && format('- **æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³**: {0}å€‹', steps.parse_results.outputs.successful_patterns) || '' }}
          ${{ steps.parse_results.outputs.has_results == 'true' && format('- **æœ€å„ªç§€ãƒ‘ã‚¿ãƒ¼ãƒ³**: {0} (ã‚¹ã‚³ã‚¢: {1})', steps.parse_results.outputs.best_pattern, steps.parse_results.outputs.best_score) || '' }}
          
          ${{ steps.parse_results.outputs.gdoc_url != 'N/A' && format('### ğŸ“„ [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ]({0})', steps.parse_results.outputs.gdoc_url) || '' }}
          
          [ğŸ“Š è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: Create Issue on Failure
      if: failure()
      uses: peter-evans/create-issue-or-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "ğŸ”§ 7ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒãƒ†ã‚¹ãƒˆå¤±æ•— #${{ github.run_number }}"
        body: |
          ## ğŸ“‹ ãƒ†ã‚¹ãƒˆå¤±æ•—è©³ç´°
          
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: 7-Prompt Pattern Comparison Test
          **å®Ÿè¡Œç•ªå·**: #${{ github.run_number }}
          **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}
          **å¯¾è±¡è¨˜äº‹æ•°**: ${{ github.event.inputs.target_articles }}
          **å¤±æ•—æ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ”— ãƒªãƒ³ã‚¯
          - [ğŸ“Š å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ“ ã‚³ãƒŸãƒƒãƒˆ](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### ğŸ› ï¸ å¯¾å¿œæ–¹æ³•
          1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª
          2. å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          3. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          4. APIåˆ¶é™ã‚„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å¯èƒ½æ€§ã‚’ç¢ºèª
          5. ä¿®æ­£å¾Œã€æ‰‹å‹•ã§å†å®Ÿè¡Œ
          
          ### ğŸ“Š ç’°å¢ƒæƒ…å ±
          - Python: 3.11
          - OS: ubuntu-latest
          - Gemini API: ${{ env.GEMINI_API_KEY != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          - Googleèªè¨¼: ${{ env.GOOGLE_OAUTH2_CLIENT_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          - ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${{ github.event.inputs.data_source }}
          
          ### ğŸ” ç¢ºèªé …ç›®
          - [ ] Gemini API Keyã®æœ‰åŠ¹æ€§ç¢ºèª
          - [ ] Googleèªè¨¼æƒ…å ±ã®æ›´æ–°ç¢ºèª
          - [ ] ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          - [ ] ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª
          - [ ] GitHub Actionså®Ÿè¡Œæ™‚é–“åˆ¶é™ã®ç¢ºèª