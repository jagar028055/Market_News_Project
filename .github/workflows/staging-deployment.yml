name: Staging Deployment Pipeline

on:
  push:
    branches:
      - develop
      - feature/*
      - fix/*
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - 'staging'
        - 'production'
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  run-tests:
    name: Run Tests Before Deployment
    if: github.event.inputs.skip_tests != 'true'
    uses: ./.github/workflows/test.yml
    with:
      test_level: 'all'
      coverage_threshold: '75'

  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
  staging-deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: run-tests
    if: always() && (needs.run-tests.result == 'success' || needs.run-tests.result == 'skipped' || github.event.inputs.skip_tests == 'true')
    environment:
      name: staging
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/staging/

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg mecab mecab-ipadic-utf8 libmecab-dev fonts-noto-cjk

    - name: Configure staging environment
      run: |
        echo "ğŸ—ï¸ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®è¨­å®š"
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®è¨­å®šä½œæˆ
        mkdir -p staging-config
        
        # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
        cat > staging-config/staging.env << EOF
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨è¨­å®š
        ENVIRONMENT=staging
        DEBUG=true
        ENABLE_PODCAST_GENERATION=false
        FORCE_DOCUMENT_GENERATION=true
        STAGING_MODE=true
        
        # ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼å€¤
        GEMINI_API_KEY=staging-dummy-key
        GOOGLE_AUTH_METHOD=mock
        PODCAST_TEST_MODE=true
        EOF
        
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°è¨­å®šå®Œäº†"

    - name: Build staging application
      env:
        ENVIRONMENT: staging
        STAGING_MODE: true
        FORCE_DOCUMENT_GENERATION: true
        GEMINI_API_KEY: staging-dummy-key
        GOOGLE_AUTH_METHOD: mock
      run: |
        echo "ğŸ”¨ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰"
        
        # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰
        timeout 300 python main.py || echo "âš ï¸ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§ã¯è¨±å®¹ï¼‰"
        
        # ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -f "index.html" ]; then
          echo "âœ… index.html ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
        else
          echo "âš ï¸ index.html ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒŸãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
          cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ - Staging</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { background: white; padding: 20px; border-radius: 8px; }
                .staging-badge { background: orange; color: white; padding: 5px 10px; border-radius: 3px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“° ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ <span class="staging-badge">STAGING</span></h1>
                <p>ã“ã‚Œã¯ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã™ã€‚</p>
                <p><strong>ãƒ–ãƒ©ãƒ³ãƒ:</strong> ${{ github.ref_name }}</p>
                <p><strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${{ github.sha }}</p>
                <p><strong>ãƒ“ãƒ«ãƒ‰æ™‚åˆ»:</strong> $(date)</p>
                <p><strong>ãƒ†ã‚¹ãƒˆçµæœ:</strong> ${{ needs.run-tests.result || 'ã‚¹ã‚­ãƒƒãƒ—' }}</p>
            </div>
        </body>
        </html>
        EOF
        fi

    - name: Prepare staging files
      run: |
        echo "ğŸ“ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™"
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        mkdir -p staging-public
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        cp index.html staging-public/
        
        # ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -d "assets" ]; then
          cp -r assets staging-public/
        fi
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        cat > staging-public/staging-info.json << EOF
        {
          "environment": "staging",
          "branch": "${{ github.ref_name }}",
          "commit": "${{ github.sha }}",
          "build_time": "$(date -Iseconds)",
          "test_result": "${{ needs.run-tests.result || 'skipped' }}",
          "workflow_run": "${{ github.run_id }}"
        }
        EOF
        
        echo "âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«æº–å‚™å®Œäº†"

    - name: Deploy to staging environment
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./staging-public
        publish_branch: gh-pages
        destination_dir: staging/${{ github.ref_name }}
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy staging: ${{ github.ref_name }}@${{ github.sha }}'

    - name: Update staging index
      run: |
        echo "ğŸ“‹ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°"
        
        # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã®ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
        mkdir -p staging-index
        cat > staging-index/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒä¸€è¦§</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f0f0f0; }
                .container { background: white; padding: 30px; border-radius: 10px; }
                .env-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
                .active { background: #e8f5e8; border-color: #4CAF50; }
                a { color: #1976d2; text-decoration: none; }
                a:hover { text-decoration: underline; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒä¸€è¦§</h1>
                
                <div class="env-card active">
                    <h3>ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}</h3>
                    <p><strong>ã‚³ãƒŸãƒƒãƒˆ:</strong> ${{ github.sha }}</p>
                    <p><strong>æ›´æ–°æ™‚åˆ»:</strong> $(date)</p>
                    <a href="./staging/${{ github.ref_name }}/">ğŸ“± ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã‚’é–‹ã</a>
                </div>
                
                <hr>
                <p><small>
                    ğŸ“Š <a href="https://github.com/${{ github.repository }}/actions">GitHub Actions</a> | 
                    ğŸ”§ <a href="https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}">ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</a>
                </small></p>
            </div>
        </body>
        </html>
        EOF
        
    - name: Deploy staging index
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./staging-index
        publish_branch: gh-pages
        destination_dir: staging
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Update staging index: ${{ github.ref_name }}'

  # ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒã¸ã®ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼‰
  promote-to-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    needs: [run-tests, staging-deploy]
    if: github.event.inputs.environment == 'production' && needs.run-tests.result == 'success' && needs.staging-deploy.result == 'success'
    environment:
      name: production
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify production readiness
      run: |
        echo "ğŸ” ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™çŠ¶æ³ã®ç¢ºèª"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
        echo "ãƒ†ã‚¹ãƒˆçµæœ: ${{ needs.run-tests.result }}"
        echo "ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°çµæœ: ${{ needs.staging-deploy.result }}"
        
        # ãƒã‚¹ã‚¿ãƒ¼ãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½
        if [[ "${{ github.ref_name }}" != "master" && "${{ github.ref_name }}" != "main" ]]; then
          echo "âŒ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ã¯master/mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ã¿å¯èƒ½ã§ã™"
          exit 1
        fi
        
        echo "âœ… ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™å®Œäº†"

    - name: Trigger production workflow
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ğŸš€ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼"
        
        # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ‰‹å‹•å®Ÿè¡Œ
        gh workflow run "Market News Scraper" \
          --ref ${{ github.ref_name }} \
          --field enable_podcast=false
        
        echo "âœ… ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–‹å§‹"

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [run-tests, staging-deploy, promote-to-production]
    if: always()

    steps:
    - name: Generate deployment summary
      run: |
        echo "# ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ãƒ†ãƒ¼ã‚¸ | çµæœ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | ${{ needs.run-tests.result == 'success' && 'âœ… æˆåŠŸ' || needs.run-tests.result == 'failure' && 'âŒ å¤±æ•—' || needs.run-tests.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âšª æœªå®Ÿè¡Œ' }} | å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤ | ${{ needs.staging-deploy.result == 'success' && 'âœ… æˆåŠŸ' || needs.staging-deploy.result == 'failure' && 'âŒ å¤±æ•—' || 'âšª æœªå®Ÿè¡Œ' }} | ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ | ${{ needs.promote-to-production.result == 'success' && 'âœ… æˆåŠŸ' || needs.promote-to-production.result == 'failure' && 'âŒ å¤±æ•—' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | æœ¬ç•ªç’°å¢ƒã¸ã®åæ˜  |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.staging-deploy.result }}" == "success" ]]; then
          echo "## ğŸŒ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/staging/${{ github.ref_name }}/" >> $GITHUB_STEP_SUMMARY
          echo "**ãƒ–ãƒ©ãƒ³ãƒ:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ™‚åˆ»:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡ŒID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR with staging link
      if: github.event_name == 'pull_request' && needs.staging-deploy.result == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          const stagingUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/staging/${{ github.head_ref }}/`;
          const comment = `## ğŸš€ ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
          
          ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼š
          
          ğŸŒ **ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚° URL:** ${stagingUrl}
          
          ### ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±
          - **ãƒ–ãƒ©ãƒ³ãƒ:** \`${{ github.head_ref }}\`
          - **ã‚³ãƒŸãƒƒãƒˆ:** \`${{ github.event.pull_request.head.sha }}\`
          - **ãƒ†ã‚¹ãƒˆçµæœ:** ${{ needs.run-tests.result || 'ã‚¹ã‚­ãƒƒãƒ—' }}
          - **ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»:** ${new Date().toLocaleString('ja-JP')}
          
          ### ç¢ºèªé …ç›®
          - [ ] åŸºæœ¬æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
          - [ ] ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹
          - [ ] ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
          - [ ] ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã®å‹•ä½œ
          
          ãƒãƒ¼ã‚¸å¾Œã€æœ¬ç•ªç’°å¢ƒã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });