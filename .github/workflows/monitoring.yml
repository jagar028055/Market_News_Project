name: Production Monitoring & Health Check

on:
  schedule:
    # æ¯æ™‚0åˆ†ã€30åˆ†ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    - cron: '0,30 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      check_type:
        description: 'Type of health check to perform'
        required: false
        default: 'all'
        type: choice
        options:
        - 'basic'
        - 'advanced' 
        - 'performance'
        - 'all'
      alert_threshold:
        description: 'Alert threshold (seconds for response time)'
        required: false
        default: '10'
        type: string

jobs:
  health-check:
    name: Website Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Basic connectivity test
      id: basic-check
      run: |
        echo "ğŸ¥ åŸºæœ¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹"
        
        SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        ALERT_THRESHOLD="${{ github.event.inputs.alert_threshold || '10' }}"
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
        START_TIME=$(date +%s.%N)
        HTTP_STATUS=$(curl -s -o /tmp/response.html -w "%{http_code}" --max-time 30 "$SITE_URL" || echo "000")
        END_TIME=$(date +%s.%N)
        
        RESPONSE_TIME=$(echo "$END_TIME - $START_TIME" | bc -l)
        RESPONSE_TIME_INT=$(echo "$RESPONSE_TIME" | cut -d. -f1)
        
        echo "ã‚µã‚¤ãƒˆURL: $SITE_URL"
        echo "HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $HTTP_STATUS"
        echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${RESPONSE_TIME}ç§’"
        
        # çµæœåˆ¤å®š
        if [[ "$HTTP_STATUS" == "200" ]]; then
          echo "âœ… ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹: æ­£å¸¸"
          echo "status=healthy" >> $GITHUB_OUTPUT
        elif [[ "$HTTP_STATUS" == "404" ]]; then
          echo "âš ï¸ ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹: 404ã‚¨ãƒ©ãƒ¼"
          echo "status=warning" >> $GITHUB_OUTPUT
        else
          echo "âŒ ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹: ç•°å¸¸ (Status: $HTTP_STATUS)"
          echo "status=error" >> $GITHUB_OUTPUT
        fi
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ãƒã‚§ãƒƒã‚¯
        if (( $(echo "$RESPONSE_TIME_INT > $ALERT_THRESHOLD" | bc -l) )); then
          echo "âš ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“è­¦å‘Š: ${RESPONSE_TIME}ç§’ > ${ALERT_THRESHOLD}ç§’"
          echo "performance=slow" >> $GITHUB_OUTPUT
        else
          echo "âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: æ­£å¸¸"
          echo "performance=good" >> $GITHUB_OUTPUT
        fi
        
        echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
        echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        echo "site_url=$SITE_URL" >> $GITHUB_OUTPUT

    - name: Content validation
      if: steps.basic-check.outputs.http_status == '200'
      id: content-check
      run: |
        echo "ğŸ“ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼"
        
        if [ -f "/tmp/response.html" ]; then
          CONTENT=$(cat /tmp/response.html)
          
          # åŸºæœ¬çš„ãªHTMLæ§‹é€ ãƒã‚§ãƒƒã‚¯
          if [[ "$CONTENT" == *"<html"* ]] && [[ "$CONTENT" == *"</html>"* ]]; then
            echo "âœ… HTMLæ§‹é€ : æ­£å¸¸"
            echo "html_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ HTMLæ§‹é€ : ç•°å¸¸"
            echo "html_valid=false" >> $GITHUB_OUTPUT
          fi
          
          # æœŸå¾…ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å­˜åœ¨ç¢ºèª
          EXPECTED_KEYWORDS=("ãƒãƒ¼ã‚±ãƒƒãƒˆ" "Market" "News" "ãƒ‹ãƒ¥ãƒ¼ã‚¹")
          FOUND_KEYWORDS=0
          
          for keyword in "${EXPECTED_KEYWORDS[@]}"; do
            if [[ "$CONTENT" == *"$keyword"* ]]; then
              echo "âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹: $keyword"
              ((FOUND_KEYWORDS++))
            fi
          done
          
          if [[ $FOUND_KEYWORDS -gt 0 ]]; then
            echo "âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: æ­£å¸¸ ($FOUND_KEYWORDS/${#EXPECTED_KEYWORDS[@]} ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹)"
            echo "content_valid=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„: æœŸå¾…ã•ã‚Œã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "content_valid=false" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          CONTENT_SIZE=$(wc -c < /tmp/response.html)
          echo "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚º: ${CONTENT_SIZE}ãƒã‚¤ãƒˆ"
          
          if [[ $CONTENT_SIZE -lt 100 ]]; then
            echo "âš ï¸ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºãŒå°ã•ã™ãã¾ã™"
            echo "size_warning=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚º: æ­£å¸¸"
            echo "size_warning=false" >> $GITHUB_OUTPUT
          fi
          
          echo "content_size=$CONTENT_SIZE" >> $GITHUB_OUTPUT
        else
          echo "âŒ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "content_valid=false" >> $GITHUB_OUTPUT
        fi

    - name: Advanced performance check
      if: github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == 'all'
      id: performance-check
      run: |
        echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ"
        
        SITE_URL="${{ steps.basic-check.outputs.site_url }}"
        
        # è¤‡æ•°å›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“æ¸¬å®š
        declare -a RESPONSE_TIMES
        TOTAL_TIME=0
        SUCCESSFUL_REQUESTS=0
        
        for i in {1..5}; do
          echo "ãƒ†ã‚¹ãƒˆ $i/5 å®Ÿè¡Œä¸­..."
          START_TIME=$(date +%s.%N)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$SITE_URL" || echo "000")
          END_TIME=$(date +%s.%N)
          
          if [[ "$STATUS" == "200" ]]; then
            RESPONSE_TIME=$(echo "$END_TIME - $START_TIME" | bc -l)
            RESPONSE_TIMES[$i]=$RESPONSE_TIME
            TOTAL_TIME=$(echo "$TOTAL_TIME + $RESPONSE_TIME" | bc -l)
            ((SUCCESSFUL_REQUESTS++))
            echo "  ãƒ†ã‚¹ãƒˆ $i: ${RESPONSE_TIME}ç§’ (æˆåŠŸ)"
          else
            echo "  ãƒ†ã‚¹ãƒˆ $i: å¤±æ•— (Status: $STATUS)"
          fi
          
          sleep 2 # ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”
        done
        
        if [[ $SUCCESSFUL_REQUESTS -gt 0 ]]; then
          AVERAGE_TIME=$(echo "scale=3; $TOTAL_TIME / $SUCCESSFUL_REQUESTS" | bc -l)
          SUCCESS_RATE=$(echo "scale=2; $SUCCESSFUL_REQUESTS * 100 / 5" | bc -l)
          
          echo "æˆåŠŸç‡: ${SUCCESS_RATE}%"
          echo "å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${AVERAGE_TIME}ç§’"
          
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "average_response_time=$AVERAGE_TIME" >> $GITHUB_OUTPUT
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡
          if (( $(echo "$SUCCESS_RATE >= 80" | bc -l) )) && (( $(echo "$AVERAGE_TIME <= 5" | bc -l) )); then
            echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: è‰¯å¥½"
            echo "performance_status=good" >> $GITHUB_OUTPUT
          elif (( $(echo "$SUCCESS_RATE >= 60" | bc -l) )) && (( $(echo "$AVERAGE_TIME <= 10" | bc -l) )); then
            echo "âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: æ³¨æ„"
            echo "performance_status=warning" >> $GITHUB_OUTPUT
          else
            echo "âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: å•é¡Œã‚ã‚Š"
            echo "performance_status=critical" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ å…¨ã¦ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãŒå¤±æ•—"
          echo "performance_status=critical" >> $GITHUB_OUTPUT
        fi

    - name: Generate health report
      id: health-report
      run: |
        echo "ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
        
        # ç·åˆçš„ãªãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¨ˆç®—
        HEALTH_SCORE=100
        ISSUES=()
        
        # åŸºæœ¬ãƒã‚§ãƒƒã‚¯çµæœã®è©•ä¾¡
        if [[ "${{ steps.basic-check.outputs.status }}" != "healthy" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 50))
          ISSUES+=("ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹ç•°å¸¸")
        fi
        
        if [[ "${{ steps.basic-check.outputs.performance }}" == "slow" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 20))
          ISSUES+=("ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“é…å»¶")
        fi
        
        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒã‚§ãƒƒã‚¯çµæœã®è©•ä¾¡
        if [[ "${{ steps.content-check.outputs.content_valid }}" == "false" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 20))
          ISSUES+=("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç•°å¸¸")
        fi
        
        if [[ "${{ steps.content-check.outputs.size_warning }}" == "true" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 10))
          ISSUES+=("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºè­¦å‘Š")
        fi
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœã®è©•ä¾¡ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰
        PERF_STATUS="${{ steps.performance-check.outputs.performance_status }}"
        if [[ "$PERF_STATUS" == "critical" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 30))
          ISSUES+=("ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡å¤§å•é¡Œ")
        elif [[ "$PERF_STATUS" == "warning" ]]; then
          HEALTH_SCORE=$((HEALTH_SCORE - 15))
          ISSUES+=("ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ³¨æ„")
        fi
        
        # æœ€çµ‚åˆ¤å®š
        if [[ $HEALTH_SCORE -ge 90 ]]; then
          OVERALL_STATUS="healthy"
          STATUS_EMOJI="âœ…"
          STATUS_TEXT="æ­£å¸¸"
        elif [[ $HEALTH_SCORE -ge 70 ]]; then
          OVERALL_STATUS="warning"
          STATUS_EMOJI="âš ï¸"
          STATUS_TEXT="æ³¨æ„"
        else
          OVERALL_STATUS="critical"
          STATUS_EMOJI="âŒ"
          STATUS_TEXT="é‡å¤§"
        fi
        
        echo "ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢: $HEALTH_SCORE/100"
        echo "ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS_EMOJI $STATUS_TEXT"
        
        # å•é¡ŒãŒã‚ã‚‹å ´åˆã¯è©³ç´°ã‚’å‡ºåŠ›
        if [[ ${#ISSUES[@]} -gt 0 ]]; then
          echo "æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:"
          printf '  - %s\n' "${ISSUES[@]}"
        fi
        
        echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
        echo "overall_status=$OVERALL_STATUS" >> $GITHUB_OUTPUT
        echo "status_text=$STATUS_TEXT" >> $GITHUB_OUTPUT
        echo "issues_count=${#ISSUES[@]}" >> $GITHUB_OUTPUT
        
        # ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ã‚‚å‡ºåŠ›
        REPORT_JSON=$(cat << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "site_url": "${{ steps.basic-check.outputs.site_url }}",
          "health_score": $HEALTH_SCORE,
          "overall_status": "$OVERALL_STATUS",
          "basic_check": {
            "http_status": "${{ steps.basic-check.outputs.http_status }}",
            "response_time": "${{ steps.basic-check.outputs.response_time }}",
            "status": "${{ steps.basic-check.outputs.status }}"
          },
          "content_check": {
            "html_valid": "${{ steps.content-check.outputs.html_valid }}",
            "content_valid": "${{ steps.content-check.outputs.content_valid }}",
            "content_size": "${{ steps.content-check.outputs.content_size }}"
          },
          "performance_check": {
            "success_rate": "${{ steps.performance-check.outputs.success_rate }}",
            "average_response_time": "${{ steps.performance-check.outputs.average_response_time }}",
            "status": "$PERF_STATUS"
          },
          "issues": $(printf '%s\n' "${ISSUES[@]}" | jq -R . | jq -s .)
        }
        EOF
        )
        
        echo "$REPORT_JSON" > health-report.json
        echo "âœ… ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"

    - name: Upload health report
      uses: actions/upload-artifact@v4
      with:
        name: health-report-${{ github.run_id }}
        path: health-report.json
        retention-days: 30

    - name: Create issue for critical problems
      if: steps.health-report.outputs.overall_status == 'critical'
      uses: actions/github-script@v7
      with:
        script: |
          const healthScore = "${{ steps.health-report.outputs.health_score }}";
          const issuesCount = "${{ steps.health-report.outputs.issues_count }}";
          const siteUrl = "${{ steps.basic-check.outputs.site_url }}";
          const timestamp = new Date().toLocaleString('ja-JP');
          
          const title = `ğŸš¨ æœ¬ç•ªã‚µã‚¤ãƒˆé‡å¤§å•é¡Œæ¤œå‡º (ã‚¹ã‚³ã‚¢: ${healthScore}/100)`;
          
          const body = `## ğŸš¨ æœ¬ç•ªã‚µã‚¤ãƒˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: é‡å¤§å•é¡Œ
          
          **æ¤œå‡ºæ™‚åˆ»**: ${timestamp}
          **ã‚µã‚¤ãƒˆURL**: ${siteUrl}
          **ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢**: ${healthScore}/100
          **å•é¡Œæ•°**: ${issuesCount}ä»¶
          
          ### ğŸ“Š è©³ç´°è¨ºæ–­çµæœ
          
          | é …ç›® | çŠ¶æ…‹ | è©³ç´° |
          |------|------|------|
          | HTTPã‚¢ã‚¯ã‚»ã‚¹ | ${{ steps.basic-check.outputs.status == 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸' }} | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.basic-check.outputs.http_status }} |
          | ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ | ${{ steps.basic-check.outputs.performance == 'good' ? 'âœ… æ­£å¸¸' : 'âš ï¸ é…å»¶' }} | ${{ steps.basic-check.outputs.response_time }}ç§’ |
          | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œè¨¼ | ${{ steps.content-check.outputs.content_valid == 'true' ? 'âœ… æ­£å¸¸' : 'âŒ ç•°å¸¸' }} | HTML: ${{ steps.content-check.outputs.html_valid }}, ã‚µã‚¤ã‚º: ${{ steps.content-check.outputs.content_size }}ãƒã‚¤ãƒˆ |
          
          ### ğŸ”§ æ¨å¥¨å¯¾å¿œ
          
          1. **å³åº§ã«ç¢ºèª**
             - [æœ¬ç•ªã‚µã‚¤ãƒˆ](${siteUrl})ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦çŠ¶æ³ç¢ºèª
             - [GitHub Pagesè¨­å®š](https://github.com/${{ github.repository }}/settings/pages)ã®ç¢ºèª
          
          2. **èª¿æŸ»æ‰‹é †**
             - æœ€è¿‘ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå±¥æ­´ç¢ºèª
             - GitHub Pagesã®çŠ¶æ…‹ç¢ºèª
             - DNSã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ç¢ºèª
          
          3. **å¾©æ—§æ‰‹é †**
             - å•é¡Œã«å¿œã˜ã¦æœ€æ–°ã®å®‰å®šç‰ˆã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
             - å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
          
          ### ğŸ“Š ç›£è¦–ãƒ‡ãƒ¼ã‚¿
          
          **å®Ÿè¡ŒID**: ${{ github.run_id }}
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [ç›£è¦–ãƒ­ã‚°ç¢ºèª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
          
          ---
          
          ğŸ¤– **è‡ªå‹•ç”Ÿæˆ**: ${timestamp}
          âš ï¸ **é‡è¦**: ã“ã®å•é¡Œã¯è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ç¢ºèªã¨å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚`;
          
          // æ—¢å­˜ã®é‡å¤§å•é¡ŒIssueã‚’ãƒã‚§ãƒƒã‚¯
          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['critical', 'monitoring', 'production'],
            state: 'open'
          });
          
          // æ—¢å­˜ã®å•é¡ŒãŒãªã‘ã‚Œã°æ–°è¦Issueä½œæˆ
          if (existingIssues.data.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['critical', 'monitoring', 'production', 'bug']
            });
            console.log('é‡å¤§å•é¡Œã®Issueã‚’ä½œæˆã—ã¾ã—ãŸ');
          } else {
            console.log('æ—¢å­˜ã®é‡å¤§å•é¡ŒIssueãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€æ–°è¦ä½œæˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ');
          }

    - name: Generate monitoring summary
      run: |
        echo "# ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚µã‚¤ãƒˆURL**: ${{ steps.basic-check.outputs.site_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“Š ç·åˆè©•ä¾¡" >> $GITHUB_STEP_SUMMARY
        echo "**ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢**: ${{ steps.health-report.outputs.health_score }}/100" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ${{ steps.health-report.outputs.overall_status == 'healthy' && 'âœ… æ­£å¸¸' || steps.health-report.outputs.overall_status == 'warning' && 'âš ï¸ æ³¨æ„' || 'âŒ é‡å¤§å•é¡Œ' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ” è©³ç´°çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | çµæœ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| HTTPã‚¢ã‚¯ã‚»ã‚¹ | ${{ steps.basic-check.outputs.status == 'healthy' && 'âœ… æ­£å¸¸' || 'âŒ ç•°å¸¸' }} | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${{ steps.basic-check.outputs.http_status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ | ${{ steps.basic-check.outputs.performance == 'good' && 'âœ… æ­£å¸¸' || 'âš ï¸ é…å»¶' }} | ${{ steps.basic-check.outputs.response_time }}ç§’ |" >> $GITHUB_STEP_SUMMARY
        echo "| HTMLæ§‹é€  | ${{ steps.content-check.outputs.html_valid == 'true' && 'âœ… æ­£å¸¸' || 'âŒ ç•°å¸¸' }} | å¦¥å½“æ€§ç¢ºèª |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ | ${{ steps.content-check.outputs.content_valid == 'true' && 'âœ… æ­£å¸¸' || 'âŒ ç•°å¸¸' }} | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ |" >> $GITHUB_STEP_SUMMARY
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Œã°è¿½åŠ 
        PERF_STATUS="${{ steps.performance-check.outputs.performance_status }}"
        if [[ "$PERF_STATUS" != "" ]]; then
          echo "| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ${{ steps.performance-check.outputs.performance_status == 'good' && 'âœ… è‰¯å¥½' || steps.performance-check.outputs.performance_status == 'warning' && 'âš ï¸ æ³¨æ„' || 'âŒ å•é¡Œ' }} | æˆåŠŸç‡: ${{ steps.performance-check.outputs.success_rate }}%, å¹³å‡: ${{ steps.performance-check.outputs.average_response_time }}ç§’ |" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ steps.health-report.outputs.issues_count }}" != "0" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.health-report.outputs.issues_count }}ä»¶ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
        fi

  # RSSãƒ»ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  podcast-health-check:
    name: Podcast & RSS Health Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type == 'advanced' || github.event.inputs.check_type == 'all'
    
    steps:
    - name: Check RSS feed
      run: |
        echo "ğŸ™ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆRSSãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"
        
        RSS_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/podcast/feed.xml"
        
        # RSS ãƒ•ã‚£ãƒ¼ãƒ‰ã®å­˜åœ¨ç¢ºèª
        RSS_STATUS=$(curl -s -o /tmp/rss.xml -w "%{http_code}" --max-time 10 "$RSS_URL" || echo "000")
        
        if [[ "$RSS_STATUS" == "200" ]]; then
          echo "âœ… RSSãƒ•ã‚£ãƒ¼ãƒ‰: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½"
          
          # RSSå†…å®¹ã®åŸºæœ¬æ¤œè¨¼
          if [ -f "/tmp/rss.xml" ]; then
            RSS_CONTENT=$(cat /tmp/rss.xml)
            
            if [[ "$RSS_CONTENT" == *"<rss"* ]] && [[ "$RSS_CONTENT" == *"</rss>"* ]]; then
              echo "âœ… RSSå½¢å¼: æ­£å¸¸"
            else
              echo "âš ï¸ RSSå½¢å¼: ç•°å¸¸ã®å¯èƒ½æ€§"
            fi
            
            # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ã‚«ã‚¦ãƒ³ãƒˆ
            EPISODE_COUNT=$(echo "$RSS_CONTENT" | grep -c "<item>" || echo "0")
            echo "ğŸ“Š ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: $EPISODE_COUNT"
            
            if [[ $EPISODE_COUNT -gt 0 ]]; then
              echo "âœ… ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: åˆ©ç”¨å¯èƒ½"
            else
              echo "âš ï¸ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰: ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            fi
          fi
        elif [[ "$RSS_STATUS" == "404" ]]; then
          echo "âš ï¸ RSSãƒ•ã‚£ãƒ¼ãƒ‰: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ©Ÿèƒ½ãŒç„¡åŠ¹ã®å¯èƒ½æ€§ï¼‰"
        else
          echo "âŒ RSSãƒ•ã‚£ãƒ¼ãƒ‰: ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ (Status: $RSS_STATUS)"
        fi

    - name: Check podcast directory
      run: |
        echo "ğŸ“ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª"
        
        PODCAST_DIR_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/podcast/"
        
        PODCAST_STATUS=$(curl -s -o /tmp/podcast_dir.html -w "%{http_code}" --max-time 10 "$PODCAST_DIR_URL" || echo "000")
        
        if [[ "$PODCAST_STATUS" == "200" ]]; then
          echo "âœ… ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½"
        else
          echo "âš ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: Status $PODCAST_STATUS"
        fi