name: Test Google Docs Podcast System

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode (ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰)'
        required: true
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      data_source:
        description: 'Data source (ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹)'
        required: true
        default: 'google_document'
        type: choice
        options:
        - 'google_document'
        - 'database'

jobs:
  test-gdocs-podcast:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        echo "System dependencies installed"

    - name: Test Google Docs Podcast System
      env:
        # ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹è¨­å®š
        PODCAST_DATA_SOURCE: ${{ github.event.inputs.data_source }}
        
        # Googleèªè¨¼è¨­å®š
        GOOGLE_AUTH_METHOD: 'oauth2'
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        
        # AIè¨­å®š
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_PODCAST_MODEL: 'gemini-2.5-pro-001'
        
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆè¨­å®š
        PODCAST_PRODUCTION_MODE: 'false'
        PODCAST_TARGET_DURATION_MINUTES: '10.0'
        PODCAST_TARGET_SCRIPT_CHARS: '2700'
        ENABLE_PODCAST_GENERATION: 'true'
        
        # LINEè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        
        # RSSè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        PODCAST_RSS_BASE_URL: ${{ secrets.PODCAST_RSS_BASE_URL }}
        PODCAST_AUTHOR_NAME: ${{ secrets.PODCAST_AUTHOR_NAME }}
        PODCAST_AUTHOR_EMAIL: ${{ secrets.PODCAST_AUTHOR_EMAIL }}
      
      run: |
        echo "ğŸ§ª Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æºãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ  ãƒ†ã‚¹ãƒˆé–‹å§‹"
        echo "ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${{ github.event.inputs.data_source }}"
        echo "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode }}"
        echo ""
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if [[ "${{ github.event.inputs.test_mode }}" == "true" ]]; then
          echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œ"
          python test_production_podcast_with_gdocs.py <<< "1"
        else
          echo "ğŸš€ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ã®å®Ÿè¡Œ"
          python test_production_podcast_with_gdocs.py <<< "2"
        fi

    - name: Upload test logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: podcast-test-logs
        path: |
          logs/*.log
          logs/*.txt
        retention-days: 7

    - name: Create test results summary
      if: always()
      run: |
        echo "## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å®Ÿè¡Œæ™‚åˆ»**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ $? -eq 0 ]]; then
          echo "âœ… **ãƒ†ã‚¹ãƒˆçµæœ**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒ†ã‚¹ãƒˆçµæœ**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        if [ -d "logs" ]; then
          ls -la logs/ >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—" >> $GITHUB_STEP_SUMMARY
        else
          echo "ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Comment on commit
      if: always() && github.event_name == 'workflow_dispatch'
      uses: peter-evans/commit-comment@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## ğŸ§ª Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æºãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆçµæœ
          
          **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}
          **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode }}
          **çµæœ**: ${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}
          **å®Ÿè¡Œæ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}
          
          [ğŸ“Š è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

    - name: Create Issue on Failure
      if: failure()
      uses: peter-evans/create-issue-or-comment@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        issue-number: ${{ github.event.issue.number }}
        title: "ğŸ”§ Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€£æºãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ†ã‚¹ãƒˆå¤±æ•— #${{ github.run_number }}"
        body: |
          ## ğŸ“‹ ãƒ†ã‚¹ãƒˆå¤±æ•—è©³ç´°
          
          **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: Test Google Docs Podcast System
          **å®Ÿè¡Œç•ªå·**: #${{ github.run_number }}
          **ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹**: ${{ github.event.inputs.data_source }}
          **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.test_mode }}
          **å¤±æ•—æ™‚åˆ»**: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ”— ãƒªãƒ³ã‚¯
          - [ğŸ“Š å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ğŸ“ ã‚³ãƒŸãƒƒãƒˆ](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### ğŸ› ï¸ å¯¾å¿œæ–¹æ³•
          1. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã§ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ç¢ºèª
          2. å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          3. Googleãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ç¢ºèª
          4. ä¿®æ­£å¾Œã€æ‰‹å‹•ã§å†å®Ÿè¡Œ
          
          ### ğŸ“Š ç’°å¢ƒæƒ…å ±
          - Python: 3.11
          - OS: ubuntu-latest
          - Gemini API: ${{ env.GEMINI_API_KEY != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}
          - Googleèªè¨¼: ${{ env.GOOGLE_OAUTH2_CLIENT_ID != '' && 'âœ… è¨­å®šæ¸ˆã¿' || 'âŒ æœªè¨­å®š' }}