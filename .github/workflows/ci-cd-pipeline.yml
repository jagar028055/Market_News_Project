name: Complete CI/CD Pipeline

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      enable_podcast:
        description: 'Enable podcast generation'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  # 1. å®Œå…¨ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  comprehensive-testing:
    name: Run Comprehensive Test Suite
    uses: ./.github/workflows/test.yml
    with:
      test_level: 'all'
      coverage_threshold: '80'

  # 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    continue-on-error: true # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’ç¶šè¡Œ

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Run Bandit security linter
      run: |
        echo "ğŸ”’ Banditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ"
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ || echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"

    - name: Check for known vulnerabilities
      run: |
        echo "ğŸ›¡ï¸ æ—¢çŸ¥ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯"
        pip install -r requirements.txt
        safety check || echo "âš ï¸ è„†å¼±æ€§è­¦å‘ŠãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆç¶šè¡Œï¼‰"

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json

  # 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install memory-profiler psutil

    - name: Run performance tests
      env:
        PERFORMANCE_TEST_MODE: 'true'
        GEMINI_API_KEY: 'test-key'
        GOOGLE_AUTH_METHOD: 'mock'
      run: |
        echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        
        # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ
        python -c "
        import psutil
        import time
        import sys
        
        print('ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±:')
        print(f'  CPUæ•°: {psutil.cpu_count()}')
        print(f'  ãƒ¡ãƒ¢ãƒªå®¹é‡: {psutil.virtual_memory().total / (1024**3):.1f} GB')
        print(f'  ä½¿ç”¨å¯èƒ½ãƒ¡ãƒ¢ãƒª: {psutil.virtual_memory().available / (1024**3):.1f} GB')
        
        # åŸºæœ¬çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        start_time = time.time()
        process = psutil.Process()
        memory_before = process.memory_info().rss / (1024**2)
        
        # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è»½é‡ç‰ˆå®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        import tempfile
        with tempfile.NamedTemporaryFile() as f:
            f.write(b'test data' * 10000)
            f.flush()
        
        memory_after = process.memory_info().rss / (1024**2)
        end_time = time.time()
        
        print(f'â±ï¸ å®Ÿè¡Œæ™‚é–“: {end_time - start_time:.2f}ç§’')
        print(f'ğŸ’¾ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: {memory_before:.1f}MB â†’ {memory_after:.1f}MB')
        
        # åŸºæº–å€¤ãƒã‚§ãƒƒã‚¯
        if end_time - start_time > 30:
            print('âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è­¦å‘Š: å®Ÿè¡Œæ™‚é–“ãŒé•·ã„')
        if memory_after - memory_before > 100:
            print('âš ï¸ ãƒ¡ãƒ¢ãƒªè­¦å‘Š: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„')
        "

  # 4. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™ç¢ºèª
  production-readiness:
    name: Production Readiness Check
    runs-on: ubuntu-latest
    needs: [comprehensive-testing, security-scan, performance-test]
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Evaluate readiness criteria
      id: readiness-check
      run: |
        echo "ğŸ¯ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™çŠ¶æ³è©•ä¾¡"
        
        TESTS_PASSED="${{ needs.comprehensive-testing.result }}"
        SECURITY_STATUS="${{ needs.security-scan.result }}"
        PERFORMANCE_STATUS="${{ needs.performance-test.result }}"
        FORCE_DEPLOY="${{ github.event.inputs.force_deploy }}"
        
        echo "ãƒ†ã‚¹ãƒˆçµæœ: $TESTS_PASSED"
        echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: $SECURITY_STATUS"
        echo "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ: $PERFORMANCE_STATUS"
        echo "å¼·åˆ¶ãƒ‡ãƒ—ãƒ­ã‚¤: $FORCE_DEPLOY"
        
        # æº–å‚™å®Œäº†åˆ¤å®š
        if [[ "$TESTS_PASSED" == "success" ]] || [[ "$FORCE_DEPLOY" == "true" ]]; then
          echo "âœ… ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†"
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "status=ready" >> $GITHUB_OUTPUT
        else
          echo "âŒ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™æœªå®Œäº†"
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "status=not-ready" >> $GITHUB_OUTPUT
        fi

    - name: Generate readiness report
      run: |
        echo "# ğŸ“‹ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³æº–å‚™ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## è©•ä¾¡çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | çŠ¶æ…‹ | è©³ç´° |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | ${{ needs.comprehensive-testing.result == 'success' && 'âœ… åˆæ ¼' || 'âŒ ä¸åˆæ ¼' }} | å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | ${{ needs.security-scan.result == 'success' && 'âœ… åˆæ ¼' || needs.security-scan.result == 'failure' && 'âš ï¸ è­¦å‘Š' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | ${{ needs.performance-test.result == 'success' && 'âœ… åˆæ ¼' || needs.performance-test.result == 'failure' && 'âš ï¸ è­¦å‘Š' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | æ€§èƒ½è©•ä¾¡ |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ç·åˆè©•ä¾¡" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** ${{ steps.readiness-check.outputs.status == 'ready' && 'ğŸŸ¢ ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†' || 'ğŸ”´ ãƒ‡ãƒ—ãƒ­ã‚¤ä¿ç•™' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    outputs:
      ready: ${{ steps.readiness-check.outputs.ready }}
      status: ${{ steps.readiness-check.outputs.status }}

  # 5. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
  production-deployment:
    name: Execute Production Deployment
    needs: [comprehensive-testing, production-readiness]
    if: needs.production-readiness.outputs.ready == 'true'
    uses: ./.github/workflows/main.yml
    with:
      enable_podcast: ${{ github.event.inputs.enable_podcast || 'false' }}
    secrets: inherit

  # 6. ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  podcast-broadcast:
    name: Execute Podcast Broadcast
    needs: [production-deployment]
    if: needs.production-deployment.result == 'success' && github.event.inputs.enable_podcast == 'true'
    uses: ./.github/workflows/podcast-broadcast.yml
    secrets: inherit

  # 7. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œãƒ†ã‚¹ãƒˆ
  post-deployment-verification:
    name: Post-Deployment Verification
    runs-on: ubuntu-latest
    needs: [production-deployment]
    if: needs.production-deployment.result == 'success'

    steps:
    - name: Wait for deployment propagation
      run: |
        echo "â³ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¼æ’­å¾…æ©Ÿ"
        sleep 60

    - name: Verify production site
      run: |
        echo "ğŸ” æœ¬ç•ªã‚µã‚¤ãƒˆæ¤œè¨¼"
        
        SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        # HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
        
        if [[ "$STATUS" == "200" ]]; then
          echo "âœ… ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: $SITE_URL"
        elif [[ "$STATUS" == "404" ]]; then
          echo "âš ï¸ ã‚µã‚¤ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆGitHub Pagesã®ä¼æ’­å¾…ã¡ã®å¯èƒ½æ€§ï¼‰: $SITE_URL"
        else
          echo "âŒ ã‚µã‚¤ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼ (Status: $STATUS): $SITE_URL"
        fi

    - name: Basic functionality test
      run: |
        echo "ğŸ§ª åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ"
        
        # æœ¬ç•ªã‚µã‚¤ãƒˆã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
        SITE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        
        # HTML ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
        CONTENT=$(curl -s "$SITE_URL" || echo "")
        
        if [[ "$CONTENT" == *"<html"* ]] && [[ "$CONTENT" == *"</html>"* ]]; then
          echo "âœ… HTMLæ§‹é€ ãŒæ­£å¸¸"
        else
          echo "âš ï¸ HTMLæ§‹é€ ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§"
        fi
        
        if [[ "$CONTENT" == *"ãƒãƒ¼ã‚±ãƒƒãƒˆ"* ]] || [[ "$CONTENT" == *"Market"* ]]; then
          echo "âœ… ã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ­£å¸¸"
        else
          echo "âš ï¸ æœŸå¾…ã•ã‚Œã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

  # 8. æœ€çµ‚é€šçŸ¥ã¨å¾Œå‡¦ç†
  pipeline-completion:
    name: Pipeline Completion
    runs-on: ubuntu-latest
    needs: [comprehensive-testing, security-scan, performance-test, production-readiness, production-deployment, podcast-broadcast, post-deployment-verification]
    if: always()

    steps:
    - name: Generate final report
      run: |
        echo "# ğŸš€ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## å®Ÿè¡Œã‚µãƒãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ãƒ†ãƒ¼ã‚¸ | çµæœ | æ™‚é–“ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | ${{ needs.comprehensive-testing.result == 'success' && 'âœ… æˆåŠŸ' || needs.comprehensive-testing.result == 'failure' && 'âŒ å¤±æ•—' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.security-scan.result == 'success' && 'âœ… æˆåŠŸ' || needs.security-scan.result == 'failure' && 'âš ï¸ è­¦å‘Š' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ | ${{ needs.performance-test.result == 'success' && 'âœ… æˆåŠŸ' || needs.performance-test.result == 'failure' && 'âš ï¸ è­¦å‘Š' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“‹ æº–å‚™ç¢ºèª | ${{ needs.production-readiness.result == 'success' && 'âœ… æº–å‚™å®Œäº†' || 'âŒ æº–å‚™æœªå®Œäº†' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸš€ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ | ${{ needs.production-deployment.result == 'success' && 'âœ… æˆåŠŸ' || needs.production-deployment.result == 'failure' && 'âŒ å¤±æ•—' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ™ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡ | ${{ needs.podcast-broadcast.result == 'success' && 'âœ… æˆåŠŸ' || needs.podcast-broadcast.result == 'failure' && 'âŒ å¤±æ•—' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼ | ${{ needs.post-deployment-verification.result == 'success' && 'âœ… æˆåŠŸ' || needs.post-deployment-verification.result == 'failure' && 'âŒ å¤±æ•—' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }} | - |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æˆåŠŸãƒ»å¤±æ•—ã®ç·åˆåˆ¤å®š
        if [[ "${{ needs.production-deployment.result }}" == "success" ]]; then
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸŒ æœ¬ç•ªã‚µã‚¤ãƒˆ:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.podcast-broadcast.result }}" == "success" ]]; then
            echo "**ğŸ™ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ:** é…ä¿¡å®Œäº†" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆèª²é¡Œã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ã¯å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ™‚åˆ»:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡ŒID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚³ãƒŸãƒƒãƒˆ:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup artifacts
      run: |
        echo "ğŸ§¹ ä¸è¦ãªã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—"
        # GitHub Actionsã§ã¯è‡ªå‹•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚Œã‚‹ãŸã‚ã€
        # ã“ã“ã§ã¯é‡è¦ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ä¿æŒ
        echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"