name: Social Content Preview

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode for design preview'
        required: false
        default: 'demo'
        type: choice
        options:
          - 'demo'
          - 'database'
          - 'llm_test'
      enable_llm:
        description: 'Enable LLM optimization'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
  push:
    branches:
      - 'feature/social-*'
      - 'master'
      - 'main'
    paths:
      - 'src/core/llm_content_optimizer.py'
      - 'src/core/social_content_generator.py'
      - 'src/core/gdocs_manual_curator.py'
      - 'src/renderers/**'
      - 'assets/templates/**'
      - 'scripts/dev/generate_social_demo.py'
      - 'scripts/dev/generate_from_artifacts.py'
      - 'scripts/dev/test_social_llm.py'
      - '.github/workflows/social-content-preview.yml'
      - 'index.html' # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸å¤‰æ›´æ™‚ã‚‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†ç”Ÿæˆ

jobs:
  social-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install system fonts for Japanese support
      run: |
        sudo apt-get update
        sudo apt-get install -y fonts-noto-cjk fonts-noto-color-emoji

    - name: Create demo social content
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PYTHONPATH: ${{ github.workspace }}
      run: |
        # å¸¸ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¦SNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ
        echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰SNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆä¸­..."
        
        # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè¿½åŠ å‡¦ç†
        case "${{ github.event.inputs.test_mode }}" in
          "llm_test")
            echo "ğŸ¤– LLMæœ€é©åŒ–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
            python scripts/dev/test_social_llm.py || echo "âš ï¸ LLMãƒ†ã‚¹ãƒˆã«å¤±æ•— - é€šå¸¸ç”Ÿæˆã‚’ç¶™ç¶š"
            ;;
          "demo")
            echo "ğŸ¨ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰æŒ‡å®š - ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§ç”Ÿæˆ"
            python scripts/dev/generate_social_demo.py
            ;;
          *)
            echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨˜äº‹ã‚’ä½¿ç”¨ã—ã¦ç”Ÿæˆ"
            ;;
        esac
        
        # ãƒ¡ã‚¤ãƒ³ç”Ÿæˆå‡¦ç†ï¼ˆãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã¯ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä½¿ç”¨ï¼‰
        if [ "${{ github.event.inputs.test_mode }}" != "demo" ]; then
          echo "ğŸ“Š data/articles.jsonã‹ã‚‰è¨˜äº‹ã‚’å–å¾—ã—ã¦SNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ"
          python scripts/dev/generate_from_artifacts.py
        fi

    - name: Verify generated content
      run: |
        echo "=== ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¢ºèª ==="
        
        # SNSç”»åƒã®ç¢ºèª
        if [ -d "build/social" ]; then
          echo "âœ… SNSç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
          find build/social -type f -name "*.png" | head -5
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
          for img in build/social/*/*.png; do
            if [ -f "$img" ]; then
              size=$(stat -c%s "$img")
              echo "ğŸ“¸ $img: ${size} bytes"
            fi
          done
        else
          echo "âŒ SNSç”»åƒãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
        
        # noteè¨˜äº‹ã®ç¢ºèª  
        if [ -d "build/note" ]; then
          echo "âœ… noteè¨˜äº‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
          find build/note -type f -name "*.md" | head -3
          
          # æ–‡å­—æ•°ç¢ºèª
          for note in build/note/*.md; do
            if [ -f "$note" ]; then
              chars=$(wc -c < "$note")
              echo "ğŸ“ $note: ${chars} æ–‡å­—"
            fi
          done
        else
          echo "âŒ noteè¨˜äº‹ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -d "logs/social" ]; then
          echo "âœ… ç”Ÿæˆãƒ­ã‚°:"
          find logs/social -name "*.json" | head -3
        fi

    - name: Save generated content to repository
      run: |
        echo "ğŸ’¾ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ä¿å­˜"
        
        # ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹å ´æ‰€ã«ä¿å­˜
        mkdir -p public/preview/social public/preview/note public/preview/logs
        
        # ç”Ÿæˆã•ã‚ŒãŸSNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å…¬é–‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼
        if [ -d "build/social" ]; then
          echo "ğŸ“¸ SNSç”»åƒã‚’ä¿å­˜: public/preview/social/"
          cp -r build/social/* public/preview/social/ 2>/dev/null || true
          
          # ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          echo "ä¿å­˜ã•ã‚ŒãŸSNSç”»åƒ:"
          find public/preview/social -name "*.png" | head -5
        fi
        
        if [ -d "build/note" ]; then
          echo "ğŸ“ noteè¨˜äº‹ã‚’ä¿å­˜: public/preview/note/"
          cp -r build/note/* public/preview/note/ 2>/dev/null || true
          
          # ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
          echo "ä¿å­˜ã•ã‚ŒãŸnoteè¨˜äº‹:"
          find public/preview/note -name "*.md" | head -3
        fi
        
        if [ -d "logs/social" ]; then
          echo "ğŸ“Š ãƒ­ã‚°ã‚’ä¿å­˜: public/preview/logs/"
          cp -r logs/social/* public/preview/logs/ 2>/dev/null || true
        fi
        
        # SNSãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹HTMLã‚‚ä¿å­˜
        cat > public/preview/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ja">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Social Content Preview</title>
            <style>
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; margin: 2rem; }
                .container { max-width: 1200px; margin: 0 auto; }
                .section { margin: 2rem 0; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
                .image-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
                .image-item { text-align: center; }
                .image-item img { max-width: 100%; height: auto; border: 1px solid #ccc; border-radius: 4px; }
                .note-preview { background: #f9f9f9; padding: 1rem; border-radius: 4px; max-height: 400px; overflow-y: auto; }
                pre { background: #f4f4f4; padding: 1rem; border-radius: 4px; overflow-x: auto; }
                .meta { color: #666; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <div class="container">
                <nav style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                    <a href="https://jagar028055.github.io/Market_News_Project/" style="color: #0066cc; text-decoration: none; font-weight: bold;">â† ãƒ¡ã‚¤ãƒ³ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
                    <span style="color: #666; margin: 0 1rem;">|</span>
                    <span style="color: #666; font-size: 0.9em;">SNSå°‚ç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆ</span>
                </nav>
                
                <h1>ğŸ¨ Social Content Preview</h1>
                <p class="meta">Generated: $(date)</p>
                
                <div class="section">
                    <h2>ğŸ“¸ SNSç”»åƒ</h2>
                    <div class="image-grid" id="social-images">
                        <!-- JavaScript ã§ç”»åƒã‚’å‹•çš„ã«æŒ¿å…¥ -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>ğŸ“ noteè¨˜äº‹</h2>
                    <div id="note-articles">
                        <!-- JavaScript ã§è¨˜äº‹ã‚’å‹•çš„ã«æŒ¿å…¥ -->
                    </div>
                </div>
                
                <div class="section">
                    <h2>ğŸ“Š ç”Ÿæˆãƒ­ã‚°</h2>
                    <div id="generation-logs">
                        <!-- JavaScript ã§ãƒ­ã‚°ã‚’å‹•çš„ã«æŒ¿å…¥ -->
                    </div>
                </div>
            </div>
            
            <script>
                // å®Ÿéš›ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‹•çš„ã«æ¤œç´¢ãƒ»è¡¨ç¤º
                async function loadSocialContent() {
                    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
                    const today = new Date().toISOString().slice(0,10).replace(/-/g, '');
                    
                    // SNSç”»åƒã®è¡¨ç¤º
                    const imageFiles = [
                        'news_01_16x9.png',
                        'news_02_16x9.png', 
                        'news_03_16x9.png'
                    ];
                    
                    let imagesHtml = '';
                    imageFiles.forEach(filename => {
                        // æ—¥ä»˜ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã‚’ç¢ºèªã—ã¦ãƒ‘ã‚¹ã‚’è¨­å®š
                        const imagePath = \`social/\${today}/\${filename}\`;
                        imagesHtml += \`
                            <div class="image-item">
                                <img src="\${imagePath}" alt="\${filename}" 
                                     onload="this.style.display='block'; this.nextElementSibling.nextElementSibling.style.color='green'; this.nextElementSibling.nextElementSibling.innerHTML='âœ… \${filename}';" 
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                <p style="display:none; color:red;">âŒ ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: \${filename}</p>
                                <p style="color:#666;">\${filename}</p>
                            </div>
                        \`;
                    });
                    
                    document.getElementById('social-images').innerHTML = imagesHtml;
                    
                    // noteè¨˜äº‹ã®è¡¨ç¤º
                    const noteDate = new Date().toISOString().slice(0,10);
                    const notePath = \`note/\${noteDate}.md\`;
                    
                    // noteè¨˜äº‹ã®å­˜åœ¨ç¢ºèªã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    try {
                        const noteResponse = await fetch(notePath);
                        if (noteResponse.ok) {
                            const noteContent = await noteResponse.text();
                            const noteHtml = \`
                                <div>
                                    <h3>ğŸ“ \${noteDate}.md</h3>
                                    <div style="border: 1px solid #ccc; border-radius: 4px; padding: 1rem; background: #f9f9f9;">
                                        <p><a href="\${notePath}" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: bold;">ğŸ“– è¨˜äº‹ã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã</a></p>
                                        <div class="note-preview" style="margin-top: 1rem; max-height: 200px; overflow-y: auto; background: white; padding: 1rem; border-radius: 4px;">
                                            <pre style="white-space: pre-wrap; font-family: inherit; background: none; padding: 0; margin: 0;">\${noteContent.substring(0, 500)}...</pre>
                                        </div>
                                        <p class="meta" style="color: #666; font-size: 0.9em; margin-top: 0.5rem;">æ–‡å­—æ•°: \${noteContent.length} æ–‡å­—</p>
                                    </div>
                                </div>
                            \`;
                            document.getElementById('note-articles').innerHTML = noteHtml;
                        } else {
                            throw new Error('Note not found');
                        }
                    } catch (error) {
                        const noteHtml = \`
                            <div>
                                <h3>ğŸ“ noteè¨˜äº‹</h3>
                                <div style="border: 1px solid #ccc; border-radius: 4px; padding: 1rem; background: #fff3cd;">
                                    <p style="color: #856404;">âš ï¸ noteè¨˜äº‹ãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                    <p class="meta" style="color: #666; font-size: 0.9em;">æœŸå¾…ãƒ‘ã‚¹: \${notePath}</p>
                                </div>
                            </div>
                        \`;
                        document.getElementById('note-articles').innerHTML = noteHtml;
                    }
                }
                
                // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
                document.addEventListener('DOMContentLoaded', loadSocialContent);
            </script>
        </body>
        </html>
        EOF
        
        echo "âœ… SNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¿å­˜å®Œäº†"

    - name: Commit generated social content
      run: |
        echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸSNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’Gitã«ã‚³ãƒŸãƒƒãƒˆ"
        
        # Gitè¨­å®š
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add public/preview/
        
        # ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèª
        if git diff --staged --quiet; then
          echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆã™ã‚‹å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
        else
          # ã‚³ãƒŸãƒƒãƒˆå®Ÿè¡Œ
          git commit -m "feat: Generate social content for $(date +%Y-%m-%d)
          
          ğŸ“¸ SNSç”»åƒç”Ÿæˆå®Œäº†
          ğŸ“ noteè¨˜äº‹ç”Ÿæˆå®Œäº†  
          ğŸ“Š ç”Ÿæˆãƒ­ã‚°ä¿å­˜å®Œäº†
          
          ä¿å­˜å ´æ‰€:
          - public/preview/social/ (SNSç”»åƒ)
          - public/preview/note/ (noteè¨˜äº‹)
          - public/preview/logs/ (ç”Ÿæˆãƒ­ã‚°)
          - public/preview/index.html (ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸)
          
          ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
          
          Co-Authored-By: Claude <noreply@anthropic.com>"
          
          # ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œ
          git push
          
          echo "âœ… SNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        fi

    - name: Create run summary
      run: |
        echo "# ğŸ¨ Social Content Preview" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ç”Ÿæˆçµæœ" >> $GITHUB_STEP_SUMMARY
        
        # SNSç”»åƒã®çµæœ
        if [ -d "build/social" ]; then
          echo "### ğŸ“¸ SNSç”»åƒ" >> $GITHUB_STEP_SUMMARY
          image_count=$(find build/social -name "*.png" | wc -l)
          echo "- ç”Ÿæˆæšæ•°: ${image_count}æš" >> $GITHUB_STEP_SUMMARY
          
          for img in build/social/*/*.png; do
            if [ -f "$img" ]; then
              filename=$(basename "$img")
              size=$(stat -c%s "$img")
              echo "- $filename: ${size} bytes" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "### âŒ SNSç”»åƒ: ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # noteè¨˜äº‹ã®çµæœ  
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d "build/note" ]; then
          echo "### ğŸ“ noteè¨˜äº‹" >> $GITHUB_STEP_SUMMARY
          note_count=$(find build/note -name "*.md" | wc -l)
          echo "- ç”Ÿæˆè¨˜äº‹æ•°: ${note_count}ä»¶" >> $GITHUB_STEP_SUMMARY
          
          for note in build/note/*.md; do
            if [ -f "$note" ]; then
              filename=$(basename "$note")
              chars=$(wc -c < "$note")
              echo "- $filename: ${chars} æ–‡å­—" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "### âŒ noteè¨˜äº‹: ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ä¿å­˜å ´æ‰€ã®æƒ…å ±
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ’¾ ä¿å­˜å ´æ‰€" >> $GITHUB_STEP_SUMMARY
        echo "ç”Ÿæˆã•ã‚ŒãŸSNSã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ä»¥ä¸‹ã®å ´æ‰€ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ:" >> $GITHUB_STEP_SUMMARY
        echo "- \`public/preview/social/\` - SNSç”»åƒ" >> $GITHUB_STEP_SUMMARY
        echo "- \`public/preview/note/\` - noteè¨˜äº‹" >> $GITHUB_STEP_SUMMARY  
        echo "- \`public/preview/logs/\` - ç”Ÿæˆãƒ­ã‚°" >> $GITHUB_STEP_SUMMARY
        echo "- \`public/preview/index.html\` - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âš ï¸ **é‡è¦**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
        echo "- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${{ github.event.inputs.test_mode == 'demo' && 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿' || 'data/articles.json' }}" >> $GITHUB_STEP_SUMMARY
        echo "- ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.test_mode || 'database' }}" >> $GITHUB_STEP_SUMMARY
        echo "- LLMæœ€é©åŒ–: ${{ github.event.inputs.enable_llm || 'true' }}" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ " >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        tree public/preview/ || find public/preview -type f | head -20
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY