name: Social Content Integration

on:
  # 毎日: メイン処理(22:00 UTC)完了後に実行する想定
  schedule:
    - cron: '40 22 * * *' # JST 7:40（UTC 22:40）
    # 追加の枠（必要時に有効化）
    # - cron: '30 03 * * 1-5' # JST 12:30（平日）
    # - cron: '00 09 * * 1-5' # JST 18:00（平日）
  workflow_dispatch:
    inputs:
      use_db_artifact:
        description: 'Use database artifact from main workflow'
        required: false
        default: 'true'
        type: choice
        options: ['true','false']
      dry_run:
        description: '画像/note生成のみ（配信なし）'
        required: false
        default: 'true'
        type: choice
        options: ['true','false']

jobs:
  social-content:
    # 手動実行は常に許可、スケジュール実行はENABLE_SOCIAL_AUTORUN変数で制御
    # 明示的な依存関係なし（自立実行可能）
    if: ${{ github.event_name == 'workflow_dispatch' || vars.ENABLE_SOCIAL_AUTORUN == 'true' || vars.ENABLE_SOCIAL_AUTORUN == null }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt
          /var/lib/apt
        key: ${{ runner.os }}-apt-social-${{ hashFiles('.github/workflows/social-content.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-social-

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq --fix-missing || true
        sudo apt-get install -y --no-install-recommends \
          sqlite3 \
          fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho \
        || echo "⚠️ Some system packages failed but continuing..."

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet --no-warn-script-location

    - name: Download database artifact (from main workflow)
      id: download-artifact
      if: |
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.use_db_artifact == 'true')
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: market-news-db
        path: .
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Validate database file
      id: validate-db
      run: |
        if [ -f "market_news.db" ]; then
          if sqlite3 market_news.db ".tables" > /dev/null 2>&1; then
            echo "db_valid=true" >> $GITHUB_OUTPUT
            echo "✅ Database file is valid and ready"
          else
            echo "db_valid=false" >> $GITHUB_OUTPUT
            echo "❌ Database file is corrupted"
            rm -f market_news.db
          fi
        else
          echo "db_valid=false" >> $GITHUB_OUTPUT
          echo "❌ Database file not found"
        fi

    - name: Create fallback database (if artifact download failed)
      id: create-fallback-db
      if: steps.validate-db.outputs.db_valid == 'false'
      run: |
        echo "🔄 Creating fallback database..."
        echo "Artifact download status: ${{ steps.download-artifact.outcome }}"
        
        # Create a minimal database with sample data
        sqlite3 market_news.db "
        CREATE TABLE IF NOT EXISTS articles (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          url TEXT UNIQUE,
          url_hash TEXT,
          title TEXT,
          body TEXT,
          source TEXT,
          category TEXT,
          published_at DATETIME,
          scraped_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          content_hash TEXT
        );
        
        INSERT OR IGNORE INTO articles (title, body, source, published_at, url) VALUES 
        ('Market Analysis Update', 'Today''s market shows mixed signals with central bank policies taking center stage.', 'Reuters', datetime('now', '-1 hour')),
        ('Economic Indicators Review', 'Key economic indicators suggest continued uncertainty in global markets.', 'Bloomberg', datetime('now', '-2 hours')),
        ('Policy Updates', 'Central bank communications indicate potential shifts in monetary policy direction.', 'Reuters', datetime('now', '-3 hours'));
        "
        
        if sqlite3 market_news.db ".tables" > /dev/null 2>&1; then
          echo "db_valid=true" >> $GITHUB_OUTPUT
          echo "✅ Fallback database created successfully"
        else
          echo "db_valid=false" >> $GITHUB_OUTPUT
          echo "❌ Failed to create fallback database"
        fi

    - name: Generate fresh database (alternative fallback)
      id: generate-fresh-db
      if: |
        steps.validate-db.outputs.db_valid == 'false' &&
        steps.create-fallback-db.outputs.db_valid == 'false'
      timeout-minutes: 10
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        GOOGLE_AUTH_METHOD: service_account
      run: |
        echo "🔄 Attempting to generate fresh database..."
        
        # Try lightweight scraping to generate database
        python scripts/core/main.py || {
          echo "⚠️ Lightweight scraping failed, using emergency fallback"
          
          # Emergency fallback with more comprehensive sample data
          sqlite3 market_news.db "
          CREATE TABLE IF NOT EXISTS articles (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            url TEXT UNIQUE,
            url_hash TEXT,
            title TEXT,
            body TEXT,
            source TEXT,
            category TEXT,
            published_at DATETIME,
            scraped_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            content_hash TEXT
          );
          
          INSERT OR IGNORE INTO articles (title, body, source, published_at, url) VALUES 
          ('Fed Signals Potential Rate Cuts Amid Economic Uncertainty', 'The Federal Reserve is considering interest rate reductions as economic indicators show mixed signals. Market analysts suggest this could signal a shift in monetary policy direction.', 'Reuters', datetime('now', '-30 minutes')),
          ('ECB Officials Divided on Interest Rate Strategy', 'European Central Bank policymakers are showing diverging views on future interest rate decisions. Some officials suggest easing monetary policy while others advocate for continued restraint.', 'Bloomberg', datetime('now', '-1 hour')),
          ('G7 Considers Enhanced Sanctions on Energy Imports', 'Finance ministers from G7 nations are discussing additional sanctions targeting countries purchasing Russian energy products. The move aims to strengthen economic pressure.', 'Reuters', datetime('now', '-2 hours')),
          ('Market Volatility Increases Amid Policy Uncertainty', 'Global markets are experiencing heightened volatility as investors weigh conflicting signals from central banks and geopolitical developments.', 'Reuters', datetime('now', '-3 hours')),
          ('Inflation Data Shows Mixed Signals Across Regions', 'Latest inflation figures reveal varying trends across different economic regions, complicating central bank policy decisions.', 'Bloomberg', datetime('now', '-4 hours'));
          "
        }
        
        if sqlite3 market_news.db ".tables" > /dev/null 2>&1; then
          echo "db_valid=true" >> $GITHUB_OUTPUT
          echo "✅ Fresh database generation completed"
        else
          echo "db_valid=false" >> $GITHUB_OUTPUT
          echo "❌ All database generation methods failed"
        fi

    - name: Run social content generation (DB-based)
      id: generate-content
      timeout-minutes: 15
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        GOOGLE_AUTH_METHOD: service_account
      run: |
        echo "🚀 Generating social assets from DB"
        echo "Google Auth Method: $GOOGLE_AUTH_METHOD"
        echo "Database source: ${{ steps.validate-db.outputs.db_valid == 'true' && 'Artifact' || steps.create-fallback-db.outputs.db_valid == 'true' && 'Fallback' || steps.generate-fresh-db.outputs.db_valid == 'true' && 'Fresh Generation' || 'Unknown' }}"
        
        # Run content generation with error handling
        if python scripts/dev/generate_from_db.py; then
          echo "content_generated=true" >> $GITHUB_OUTPUT
          echo "✅ Social content generation completed successfully"
        else
          echo "content_generated=false" >> $GITHUB_OUTPUT
          echo "❌ Social content generation failed or timed out"
          exit 1
        fi

    - name: Upload social artifacts
      uses: actions/upload-artifact@v4
      with:
        name: social-content
        path: |
          build/social/**
          build/note/**
        if-no-files-found: warn
        retention-days: 5

    - name: Enhanced error handling and summary
      if: always()
      run: |
        echo "## 📊 Social Content Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DB Valid**: ${{ steps.validate-db.outputs.db_valid || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Download**: ${{ steps.download-artifact.outcome || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fallback DB Created**: ${{ steps.create-fallback-db.outputs.db_valid || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fresh DB Generated**: ${{ steps.generate-fresh-db.outputs.db_valid || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Content Generated**: ${{ steps.generate-content.outputs.content_generated || 'false' }}" >> $GITHUB_STEP_SUMMARY
        
        # Error analysis
        if [ "${{ job.status }}" = "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🔴 Error Analysis" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.download-artifact.outcome }}" = "failure" ]; then
            echo "- ❌ **Artifact Download Failed**: market-news-db not found" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.validate-db.outputs.db_valid }}" = "false" ]; then
            echo "- ❌ **Database Invalid**: Cannot proceed with content generation" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.create-fallback-db.outputs.db_valid }}" = "false" ]; then
            echo "- ❌ **Fallback Creation Failed**: No database available" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Success details
        if [ "${{ job.status }}" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ Generation Results" >> $GITHUB_STEP_SUMMARY
          if [ -d build/social ]; then
            echo "### 🖼️ Generated Images" >> $GITHUB_STEP_SUMMARY
            find build/social -type f -name "*.png" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
          fi
          if [ -d build/note ]; then
            echo "### 📝 Generated Notes" >> $GITHUB_STEP_SUMMARY
            find build/note -type f -name "*.md" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
          fi
        fi
        
        # Recommendations
        if [ "${{ job.status }}" = "failure" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 💡 Recommendations" >> $GITHUB_STEP_SUMMARY
          echo "- Ensure main workflow has run successfully before social content generation" >> $GITHUB_STEP_SUMMARY
          echo "- Check artifact retention settings (default: 90 days)" >> $GITHUB_STEP_SUMMARY
          echo "- Consider running main workflow manually if artifacts are missing" >> $GITHUB_STEP_SUMMARY
        fi

