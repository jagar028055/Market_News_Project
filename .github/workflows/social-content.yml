name: Social Content Integration

on:
  # æ¯Žæ—¥: ãƒ¡ã‚¤ãƒ³å‡¦ç†(22:00 UTC)å®Œäº†å¾Œã«å®Ÿè¡Œã™ã‚‹æƒ³å®š
  schedule:
    - cron: '40 22 * * *' # JST 7:40ï¼ˆUTC 22:40ï¼‰
    # è¿½åŠ ã®æž ï¼ˆå¿…è¦æ™‚ã«æœ‰åŠ¹åŒ–ï¼‰
    # - cron: '30 03 * * 1-5' # JST 12:30ï¼ˆå¹³æ—¥ï¼‰
    # - cron: '00 09 * * 1-5' # JST 18:00ï¼ˆå¹³æ—¥ï¼‰
  workflow_dispatch:
    inputs:
      use_db_artifact:
        description: 'Use database artifact from main workflow'
        required: false
        default: 'true'
        type: choice
        options: ['true','false']
      dry_run:
        description: 'ç”»åƒ/noteç”Ÿæˆã®ã¿ï¼ˆé…ä¿¡ãªã—ï¼‰'
        required: false
        default: 'true'
        type: choice
        options: ['true','false']

jobs:
  social-content:
    # æ—¢å®šã¯è‡ªå‹•å®Ÿè¡Œã‚ªãƒ•ã€‚æ‰‹å‹•å®Ÿè¡Œã¯å¸¸ã«è¨±å¯ã€‚
    if: ${{ github.event_name == 'workflow_dispatch' || vars.ENABLE_SOCIAL_AUTORUN == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt
          /var/lib/apt
        key: ${{ runner.os }}-apt-social-${{ hashFiles('.github/workflows/social-content.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-social-

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq --fix-missing || true
        sudo apt-get install -y --no-install-recommends \
          sqlite3 \
          fonts-noto-cjk fonts-ipafont-gothic fonts-ipafont-mincho \
        || echo "âš ï¸ Some system packages failed but continuing..."

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet --no-warn-script-location --no-cache-dir

    - name: Clean pip cache
      run: |
        python -m pip cache purge || true

    - name: Download database artifact (from main workflow)
      id: download-artifact
      if: |
        github.event_name == 'schedule' || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.use_db_artifact == 'true')
      uses: dawidd6/action-download-artifact@v2
      continue-on-error: true
      with:
        workflow: main.yml
        name: market-news-db
        path: .
        search_artifacts: true

    - name: Validate database file
      id: validate-db
      run: |
        if [ -f "market_news.db" ]; then
          if sqlite3 market_news.db ".tables" > /dev/null 2>&1; then
            echo "db_valid=true" >> $GITHUB_OUTPUT
          else
            echo "db_valid=false" >> $GITHUB_OUTPUT
            echo "Database file is corrupted"
            rm -f market_news.db
          fi
        else
          echo "db_valid=false" >> $GITHUB_OUTPUT
        fi

    - name: Run social content generation (DB-based)
      if: steps.validate-db.outputs.db_valid == 'true'
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ðŸš€ Generating social assets from DB (artifact valid)"
        python scripts/dev/generate_from_db.py

    - name: Fallback: skip content generation when DB missing/corrupt
      if: steps.validate-db.outputs.db_valid != 'true'
      run: |
        echo "âš ï¸ Skipping content generation because database artifact is missing or invalid"

    - name: Upload social artifacts
      uses: actions/upload-artifact@v4
      with:
        name: social-content
        path: |
          build/social/**
          build/note/**
        if-no-files-found: warn
        retention-days: 5

    - name: Workflow summary
      if: always()
      run: |
        echo "## ðŸ“Š Social Content Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **DB Valid**: ${{ steps.validate-db.outputs.db_valid || 'false' }}" >> $GITHUB_STEP_SUMMARY
        if [ -d build/social ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¼ï¸ Generated Images" >> $GITHUB_STEP_SUMMARY
          find build/social -type f -name "*.png" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY || true
        fi
