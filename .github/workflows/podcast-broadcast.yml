name: Daily Podcast Broadcast

on:
  push:
    branches:
      - 'feature/automated-podcast-system'  # ã“ã®ãƒ–ãƒ©ãƒ³ãƒã§ã®pushæ™‚ã«å®Ÿè¡Œ
    paths:
      - 'src/podcast/**'
      - '.github/workflows/podcast-broadcast.yml'
      - 'standalone_podcast_main.py'
      - 'requirements.txt'
  schedule:
    - cron: '30 22 * * *' # JST 7:30 (UTC 22:30)
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      force_run:
        description: 'Force run even if conditions are not met'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      test_mode:
        description: 'Run in test mode (no actual broadcast)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      weekdays_only:
        description: 'Run only on weekdays'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  podcast-broadcast:
    runs-on: ubuntu-latest
    permissions:
      contents: write # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run standalone podcast workflow
      env:
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡
        PODCAST_WORKFLOW_ENABLED: 'true'
        PODCAST_WEEKDAYS_ONLY: ${{ github.event.inputs.weekdays_only || secrets.PODCAST_WEEKDAYS_ONLY || 'false' }}
        PODCAST_FORCE_RUN: ${{ github.event.inputs.force_run || 'true' }}
        PODCAST_TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        
        # Googleèªè¨¼è¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨ï¼‰
        GOOGLE_AUTH_METHOD: 'oauth2'
        GOOGLE_DRIVE_OUTPUT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_OUTPUT_FOLDER_ID }}
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        
        # AIè¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨ï¼‰
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        
        # LINEé…ä¿¡è¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨ï¼‰
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆè¨­å®šï¼ˆæ—¢å­˜ã®ã‚‚ã®ã‚’å†åˆ©ç”¨ï¼‰
        PODCAST_RSS_BASE_URL: ${{ secrets.PODCAST_RSS_BASE_URL }}
        PODCAST_AUTHOR_NAME: ${{ secrets.PODCAST_AUTHOR_NAME }}
        PODCAST_AUTHOR_EMAIL: ${{ secrets.PODCAST_AUTHOR_EMAIL }}
        PODCAST_RSS_TITLE: ${{ secrets.PODCAST_RSS_TITLE || 'ãƒžãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆ' }}
        PODCAST_RSS_DESCRIPTION: ${{ secrets.PODCAST_RSS_DESCRIPTION || 'AIãŒç”Ÿæˆã™ã‚‹æ¯Žæ—¥ã®ãƒžãƒ¼ã‚±ãƒƒãƒˆãƒ‹ãƒ¥ãƒ¼ã‚¹' }}
        PODCAST_MONTHLY_COST_LIMIT: ${{ secrets.PODCAST_MONTHLY_COST_LIMIT || '10.0' }}
        PODCAST_TARGET_DURATION_MINUTES: ${{ secrets.PODCAST_TARGET_DURATION_MINUTES || '10.0' }}
        PODCAST_MAX_FILE_SIZE_MB: ${{ secrets.PODCAST_MAX_FILE_SIZE_MB || '15' }}
      timeout-minutes: 15
      run: python standalone_podcast_main.py

    - name: Prepare podcast files for deployment
      if: success()
      run: |
        # å…¬é–‹ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p public/podcast
        
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°ã‚³ãƒ”ãƒ¼
        if [ -d "podcast" ]; then
          cp -r podcast/* public/podcast/
          echo "Podcast files copied to public directory"
          ls -la public/podcast/
        else
          echo "No podcast files found to deploy"
        fi

    - name: Deploy podcast to GitHub Pages
      if: success() && github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        keep_files: true # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼ˆãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿è­·ï¼‰
        destination_dir: . # ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ‡ãƒ—ãƒ­ã‚¤
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy daily podcast: ${{ github.run_id }}'

    - name: Cleanup temporary files
      if: always()
      run: |
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        rm -rf output/podcast/episode_*.mp3
        rm -rf public/
        echo "Temporary files cleaned up"

    - name: Workflow summary
      if: always()
      run: |
        echo "## ðŸ“Š Podcast Broadcast Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force Run**: ${{ github.event.inputs.force_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Mode**: ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "podcast/market_news_$(date +%Y%m%d).mp3" ]; then
          echo "- **Podcast Generated**: âœ… Yes" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: $(du -h podcast/market_news_$(date +%Y%m%d).mp3 | cut -f1)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Podcast Generated**: âŒ No" >> $GITHUB_STEP_SUMMARY
        fi