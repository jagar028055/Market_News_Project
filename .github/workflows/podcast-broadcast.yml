name: Daily Podcast Broadcast

on:
<<<<<<< HEAD
  # schedule:  # 2025-09-15 ä¸€æ™‚åœæ­¢ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã‚ªãƒ•ï¼‰
  #   - cron: '30 22 * * *' # JST 7:30 (UTC 22:30) - é€šå‹¤æ™‚é–“å¸¯
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      use_db_artifact:
        description: 'Use database artifact from main workflow'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      force_run:
        description: 'Force run even if conditions are not met'
        required: false
        default: 'true'
        type: choice
        options:
        - 'true'
        - 'false'
      test_mode:
        description: 'Run in test mode (no actual broadcast)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      weekdays_only:
        description: 'Run only on weekdays'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
      prompt_pattern:
        description: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ'
=======
  schedule:
    - cron: '30 22 * * *' # JST 7:30 (UTC 22:30) - é€šå‹¤æ™‚é–“å¸¯
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹
    inputs:
      execution_mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'production'
        type: choice
        options:
        - 'production'       # é€šå¸¸å®Ÿè¡Œï¼ˆéŸ³å£°ç”Ÿæˆãƒ»é…ä¿¡ã‚ã‚Šï¼‰
        - 'test'             # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆé…ä¿¡ãªã—ï¼‰
        - 'script-only'      # å°æœ¬ç”Ÿæˆã®ã¿
      data_source:
        description: 'ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹'
        required: false
        default: 'auto'
        type: choice
        options:
        - 'auto'             # è‡ªå‹•åˆ¤å®šï¼ˆDBâ†’Google Docï¼‰
        - 'database'         # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¼·åˆ¶ä½¿ç”¨
        - 'google_document'  # Google Documentå¼·åˆ¶ä½¿ç”¨
      prompt_pattern:
        description: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³'
>>>>>>> origin/feature/podcast-system
        required: false
        default: 'current_professional'
        type: choice
        options:
        - 'current_professional'
        - 'cot_enhanced'
        - 'enhanced_persona'
        - 'few_shot_learning'
        - 'constraint_optimization'
        - 'context_aware'
        - 'minimalist'
<<<<<<< HEAD
      comparison_mode:
        description: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'single'
        type: choice
        options:
        - 'single'           # å˜ä¸€ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ
        - 'ab_test'          # 2ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ
        - 'multi_compare'    # è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ
      script_only:
        description: 'Script generation only (no audio/broadcast)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'
=======
>>>>>>> origin/feature/podcast-system

jobs:
  podcast-broadcast:
    runs-on: ubuntu-latest
    permissions:
      contents: write # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨
      issues: write   # å¤±æ•—æ™‚Issueä½œæˆç”¨

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

<<<<<<< HEAD
    - name: Cache APT packages
      uses: actions/cache@v4
      with:
        path: |
          /var/cache/apt
          /var/lib/apt
        key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/podcast-broadcast.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-

    - name: Install system dependencies
      run: |
        # é«˜é€ŸåŒ–ï¼šã‚¯ãƒ¯ã‚¤ã‚¨ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ + æ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãªã— + ã‚¨ãƒ©ãƒ¼ç„¡è¦–
        sudo apt-get update -qq --fix-missing || true
        sudo apt-get install -y --no-install-recommends \
          ffmpeg \
        || echo "âš ï¸ Some system packages failed but continuing..."

    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet --no-warn-script-location
        echo "âœ… Python dependencies installed successfully"
        pip list | grep -E "(google|pydub|feedgen|yaml)" || echo "âš ï¸ Some podcast dependencies may be missing"
=======
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "Python dependencies installed successfully"
        pip list | grep -E "(google|pydub|feedgen|yaml)" || echo "Some podcast dependencies may be missing"

    - name: Expand workflow parameters
      id: expand-params
      run: |
        # execution_mode ã®å±•é–‹
        case "${{ github.event.inputs.execution_mode || 'production' }}" in
          "production")
            echo "use_db_artifact=true" >> $GITHUB_OUTPUT
            echo "force_run=true" >> $GITHUB_OUTPUT
            echo "test_mode=false" >> $GITHUB_OUTPUT
            echo "script_only=false" >> $GITHUB_OUTPUT
            ;;
          "test")
            echo "use_db_artifact=true" >> $GITHUB_OUTPUT
            echo "force_run=true" >> $GITHUB_OUTPUT
            echo "test_mode=true" >> $GITHUB_OUTPUT
            echo "script_only=false" >> $GITHUB_OUTPUT
            ;;
          "script-only")
            echo "use_db_artifact=true" >> $GITHUB_OUTPUT
            echo "force_run=true" >> $GITHUB_OUTPUT
            echo "test_mode=false" >> $GITHUB_OUTPUT
            echo "script_only=true" >> $GITHUB_OUTPUT
            ;;
        esac
        
        # data_source ã®å±•é–‹ (data_source ã¯å¾Œã® steps ã§å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è¨˜éŒ²ã®ã¿)
        echo "data_source_preference=${{ github.event.inputs.data_source || 'auto' }}" >> $GITHUB_OUTPUT
        
        echo "=== Parameter Expansion Results ==="
        echo "Execution Mode: ${{ github.event.inputs.execution_mode || 'production' }}"
        echo "Data Source: ${{ github.event.inputs.data_source || 'auto' }}"
        echo "Prompt Pattern: ${{ github.event.inputs.prompt_pattern || 'current_professional' }}"
>>>>>>> origin/feature/podcast-system

    - name: Download database artifact
      id: download-artifact
      if: |
        github.event_name == 'schedule' || 
        github.event_name == 'push' ||
<<<<<<< HEAD
        (github.event_name == 'workflow_dispatch' && github.event.inputs.use_db_artifact == 'true')
=======
        (github.event_name == 'workflow_dispatch' && steps.expand-params.outputs.use_db_artifact == 'true')
>>>>>>> origin/feature/podcast-system
      uses: dawidd6/action-download-artifact@v2
      continue-on-error: true
      with:
        workflow: main.yml
        name: market-news-db
        path: .
        search_artifacts: true
        
    - name: Check artifact download result
      id: artifact-status
      run: |
        if [ -f "market_news.db" ]; then
          echo "artifact_available=true" >> $GITHUB_OUTPUT
          echo "data_source=database" >> $GITHUB_OUTPUT
          ls -la market_news.db
        else
          echo "artifact_available=false" >> $GITHUB_OUTPUT
          echo "data_source=google_document" >> $GITHUB_OUTPUT
        fi

    - name: Validate database file
      id: validate-db
      if: steps.artifact-status.outputs.artifact_available == 'true'
      run: |
        if sqlite3 market_news.db ".tables" > /dev/null 2>&1; then
          echo "db_valid=true" >> $GITHUB_OUTPUT
        else
          echo "db_valid=false" >> $GITHUB_OUTPUT
          echo "Database file is corrupted, falling back to Google Document"
          rm -f market_news.db
        fi

    - name: Final data source decision
      id: final-source
      run: |
        if [[ -f "market_news.db" && "${{ steps.validate-db.outputs.db_valid }}" == "true" ]]; then
          echo "PODCAST_DATA_SOURCE=database" >> $GITHUB_ENV
          echo "final_source=database" >> $GITHUB_OUTPUT
        else
          echo "PODCAST_DATA_SOURCE=google_document" >> $GITHUB_ENV
          echo "GOOGLE_DOCUMENT_ID=${{ secrets.GOOGLE_DOCUMENT_ID || secrets.GOOGLE_OVERWRITE_DOC_ID }}" >> $GITHUB_ENV
          echo "final_source=google_document" >> $GITHUB_OUTPUT
        fi

    - name: Log data source decision
      run: |
        echo "=== Podcast Data Source Decision ==="
        echo "Trigger: ${{ github.event_name }}"
<<<<<<< HEAD
        echo "Use artifact requested: ${{ github.event.inputs.use_db_artifact || 'N/A (scheduled)' }}"
=======
        echo "Execution mode: ${{ github.event.inputs.execution_mode || 'production' }}"
        echo "Data source preference: ${{ github.event.inputs.data_source || 'auto' }}"
        echo "Use artifact requested: ${{ steps.expand-params.outputs.use_db_artifact || 'N/A (scheduled)' }}"
>>>>>>> origin/feature/podcast-system
        echo "Artifact available: ${{ steps.artifact-status.outputs.artifact_available }}"
        echo "Database valid: ${{ steps.validate-db.outputs.db_valid }}"
        echo "Final data source: ${{ steps.final-source.outputs.final_source }}"
        echo "================================="

    - name: Verify dependencies and environment
      run: |
        echo "ğŸ” å¿…é ˆä¾å­˜é–¢ä¿‚ç¢ºèª"
        python --version
        
        # Critical dependencies check
        python -c "
        import sys
        failed = []
        
        critical_modules = [
            'google.cloud.texttospeech',
            'pydub', 
            'feedgen',
            'yaml',
            'requests'
        ]
        
        for module in critical_modules:
            try:
                __import__(module)
                print(f'âœ… {module}: OK')
            except ImportError as e:
                print(f'âŒ {module}: FAILED - {e}')
                failed.append(module)
        
        if failed:
            print(f'\\nCRITICAL: Missing modules: {failed}')
            sys.exit(1)
        else:
            print('\\nâœ… All critical dependencies verified')
        "
        
        # Google Cloud auth check
        if [ -n "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
          echo "âœ… Google Cloud auth configured"
        else
          echo "âš ï¸ WARNING: Google Cloud auth not configured"
          echo "ğŸ” DEBUG: Proceeding to investigate audio generation issues"
          echo "ğŸ“ NOTE: This may cause TTS authentication failures"
        fi

    - name: Run standalone podcast workflow
      env:
        # Core control settings
        ENABLE_PODCAST_GENERATION: 'true'
<<<<<<< HEAD
        PODCAST_FORCE_RUN: ${{ github.event.inputs.force_run || 'true' }}
        PODCAST_TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        PODCAST_PRODUCTION_MODE: 'true'
        PODCAST_SCRIPT_ONLY_MODE: ${{ github.event.inputs.script_only || 'false' }}
=======
        PODCAST_FORCE_RUN: ${{ steps.expand-params.outputs.force_run || 'true' }}
        PODCAST_TEST_MODE: ${{ steps.expand-params.outputs.test_mode || 'false' }}
        PODCAST_PRODUCTION_MODE: 'true'
        PODCAST_SCRIPT_ONLY_MODE: ${{ steps.expand-params.outputs.script_only || 'false' }}
        
        # Podcast Configuration (added prompt pattern support)
        PODCAST_PROMPT_PATTERN: ${{ github.event.inputs.prompt_pattern || 'current_professional' }}
>>>>>>> origin/feature/podcast-system
        
        # Google Authentication
        GOOGLE_OAUTH2_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH2_CLIENT_ID }}
        GOOGLE_OAUTH2_CLIENT_SECRET: ${{ secrets.GOOGLE_OAUTH2_CLIENT_SECRET }}
        GOOGLE_OAUTH2_REFRESH_TOKEN: ${{ secrets.GOOGLE_OAUTH2_REFRESH_TOKEN }}
        GOOGLE_OVERWRITE_DOC_ID: ${{ secrets.GOOGLE_OVERWRITE_DOC_ID }}
        
        # Google Cloud TTS
        GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        
        # AI Configuration
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_PODCAST_MODEL: ${{ secrets.GEMINI_PODCAST_MODEL || 'gemini-2.5-pro' }}
        
        # LINE Bot Configuration
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        
        # Podcast Configuration
        PODCAST_RSS_BASE_URL: ${{ secrets.PODCAST_RSS_BASE_URL }}
        PODCAST_AUTHOR_NAME: ${{ secrets.PODCAST_AUTHOR_NAME }}
        PODCAST_AUTHOR_EMAIL: ${{ secrets.PODCAST_AUTHOR_EMAIL }}
<<<<<<< HEAD
        PODCAST_TARGET_DURATION_MINUTES: '15.0'
=======
        PODCAST_TARGET_DURATION_MINUTES: '10.0'
>>>>>>> origin/feature/podcast-system
      timeout-minutes: 20
      run: |
        echo "ğŸ™ï¸ Starting podcast generation..."
        python scripts/core/standalone_podcast_main.py
        
        if [ $? -eq 0 ]; then
          echo "âœ… Podcast generation completed successfully"
        else
          echo "âŒ Podcast generation failed"
          exit 1
        fi

    - name: Display script-only mode results
      if: env.PODCAST_SCRIPT_ONLY_MODE == 'true'
      run: |
        echo "ğŸ“ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ - ç”Ÿæˆçµæœç¢ºèªä¸­..."
        
        # å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        SCRIPT_FOUND=0
        for script_file in output/podcast/*_script.txt; do
          if [ -f "$script_file" ]; then
            echo "âœ… å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹: $script_file"
            echo "ğŸ“Š å°æœ¬çµ±è¨ˆ:"
            echo "  æ–‡å­—æ•°: $(wc -c < "$script_file")"
            echo "  è¡Œæ•°: $(wc -l < "$script_file")"
            echo "  ã‚µã‚¤ã‚º: $(du -h "$script_file" | cut -f1)"
            echo ""
            echo "ğŸ“„ å°æœ¬å†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (æœ€åˆã®50è¡Œ):"
            echo "======================================"
            head -50 "$script_file" | while IFS= read -r line; do
              echo "  $line"
            done
            echo "======================================"
            
            # GitHub Actions Summary ã«ã‚‚å‡ºåŠ›
            echo "SCRIPT_FILE_PATH=$script_file" >> $GITHUB_ENV
            echo "SCRIPT_CONTENT_PREVIEW=true" >> $GITHUB_ENV
            SCRIPT_FOUND=1
            break
          fi
        done
        
        # å°æœ¬ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        if [ $SCRIPT_FOUND -eq 0 ]; then
          echo "âš ï¸ å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:"
          echo "  äºˆæƒ³ãƒ‘ã‚¹: output/podcast/*_script.txt"
          echo "  å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª:"
          ls -la output/ 2>/dev/null || echo "    output/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
          ls -la output/podcast/ 2>/dev/null || echo "    output/podcast/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãªã—"
          
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆã®è©³ç´°ãƒ­ã‚°ç¢ºèª
          echo "  ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆãƒ­ã‚°ç¢ºèª:"
          if [ -f "podcast_workflow.log" ]; then
            echo "    podcast_workflow.log å­˜åœ¨ ($(du -h podcast_workflow.log | cut -f1))"
            echo "    æœ€æ–°ã®ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒª:"
            tail -20 podcast_workflow.log | while IFS= read -r line; do
              echo "    $line"
            done
          else
            echo "    podcast_workflow.log ãªã—"
          fi
        fi

    - name: Prepare podcast files for deployment
      if: success()
      run: |
<<<<<<< HEAD
        echo "=== Podcast File Deployment Debug ==="
        echo "Current directory:"
        pwd
        echo "Directory contents:"
        ls -la
        
        echo "Checking for output directory:"
        if [ -d "output" ]; then
          echo "output/ directory exists:"
          ls -la output/
          if [ -d "output/podcast" ]; then
            echo "output/podcast/ directory exists:"
            ls -la output/podcast/
          else
            echo "output/podcast/ directory does not exist"
          fi
        else
          echo "output/ directory does not exist"
        fi
        
        echo "Checking for podcast directory:"
        if [ -d "podcast" ]; then
          echo "podcast/ directory exists:"
          ls -la podcast/
        else
          echo "podcast/ directory does not exist"
        fi
        
        # å…¬é–‹ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p public/podcast
        echo "Created public/podcast/ directory"
=======
        # å…¬é–‹ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        mkdir -p public/podcast
>>>>>>> origin/feature/podcast-system
        
        echo "=== ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ç¢ºèª ==="
        echo "Current directory contents:"
        ls -la
        echo "Output directory contents:"
        ls -la output/ || echo "No output directory"
        echo "Output/podcast directory contents:"
        ls -la output/podcast/ || echo "No output/podcast directory"
        echo "Podcast directory contents:"
        ls -la podcast/ || echo "No podcast directory"
        
        # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°åˆ†æ
        echo "=== éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°åˆ†æ ==="
        for audio_file in output/podcast/*.mp3 podcast/*.mp3; do
          if [ -f "$audio_file" ]; then
            echo "åˆ†æä¸­: $audio_file"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«åŸºæœ¬æƒ…å ±
            file_size=$(du -h "$audio_file" | cut -f1)
            file_size_bytes=$(stat -f%z "$audio_file" 2>/dev/null || stat -c%s "$audio_file" 2>/dev/null || echo "unknown")
            echo "  ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $file_size ($file_size_bytes bytes)"
            
            # MP3ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
            if command -v xxd >/dev/null 2>&1; then
              echo "  MP3ãƒ˜ãƒƒãƒ€ãƒ¼: $(xxd -l 16 -p "$audio_file" | head -1)"
            fi
            
            # FFprobeï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰ã§ã®éŸ³å£°åˆ†æ
            if command -v ffprobe >/dev/null 2>&1; then
              echo "  === FFprobeåˆ†æçµæœ ==="
              ffprobe -v quiet -print_format json -show_format -show_streams "$audio_file" 2>/dev/null | head -20 || echo "  FFprobeåˆ†æå¤±æ•—"
            else
              echo "  FFprobeåˆ©ç”¨ä¸å¯"
            fi
            
            # å“è³ªãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
            quality_report="${audio_file%.*}.quality_report.json"
            if [ -f "$quality_report" ]; then
              echo "  === å“è³ªãƒ¬ãƒãƒ¼ãƒˆ ==="
              cat "$quality_report" | head -20 || echo "  å“è³ªãƒ¬ãƒãƒ¼ãƒˆèª­ã¿å–ã‚Šå¤±æ•—"
            else
              echo "  å“è³ªãƒ¬ãƒãƒ¼ãƒˆãªã—: $quality_report"
            fi
            
            echo ""
          fi
        done
        
        # ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦ã‚³ãƒ”ãƒ¼
        DEPLOYED_COUNT=0
        
        # output/podcast/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        if [ -d "output/podcast" ]; then
          echo "Searching for audio files in output/podcast/..."
          for audio_file in output/podcast/*.mp3; do
            if [ -f "$audio_file" ]; then
              echo "Found audio file: $audio_file ($(du -h "$audio_file" | cut -f1))"
              cp "$audio_file" public/podcast/
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
            fi
          done
        fi
        
        # podcast/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã‚‚æ¤œç´¢ï¼ˆGitHubPagesPublisherå‡ºåŠ›ç”¨ï¼‰
        if [ -d "podcast" ]; then
          echo "Searching for audio files in podcast/..."
          for audio_file in podcast/*.mp3; do
            if [ -f "$audio_file" ]; then
              echo "Found audio file: $audio_file ($(du -h "$audio_file" | cut -f1))"
              cp "$audio_file" public/podcast/
              DEPLOYED_COUNT=$((DEPLOYED_COUNT + 1))
            fi
          done
          
          # RSS feed ã‚‚å­˜åœ¨ã™ã‚Œã°ã‚³ãƒ”ãƒ¼ï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«åã«å¯¾å¿œï¼‰
          RSS_COPIED=0
          for rss_file in podcast/podcast.rss podcast/feed.xml; do
            if [ -f "$rss_file" ]; then
              # çµ±ä¸€ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚³ãƒ”ãƒ¼ï¼ˆfeed.xml ã«çµ±ä¸€ï¼‰
              cp "$rss_file" public/podcast/feed.xml
              echo "RSS feed copied: $(basename "$rss_file") â†’ feed.xml"
              RSS_COPIED=1
              break
            fi
          done
          
          if [ $RSS_COPIED -eq 0 ]; then
            echo "âš ï¸ RSS feed not found in podcast/ directory"
          fi
          
          # å“è³ªãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å­˜åœ¨ã™ã‚Œã°ã‚³ãƒ”ãƒ¼
          for quality_report in podcast/*.quality_report.json; do
            if [ -f "$quality_report" ]; then
              cp "$quality_report" public/podcast/
              echo "Quality report copied: $(basename "$quality_report")"
            fi
          done
        fi
        
        echo "=== ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº† ==="
        echo "Deployed audio files: $DEPLOYED_COUNT"
        echo "Final public/podcast contents:"
        ls -la public/podcast/ || echo "No files in public/podcast"
        
        if [ $DEPLOYED_COUNT -eq 0 ]; then
          echo "âŒ CRITICAL: No audio files found for deployment"
          echo "ğŸš¨ This indicates audio generation failed completely"
          echo "ğŸ“Š Deployment cannot proceed without audio files"
          exit 1
        else
          echo "âœ… Successfully prepared $DEPLOYED_COUNT audio file(s) for deployment"
        fi
<<<<<<< HEAD
        
        echo "Final public directory structure:"
        find public -type f -exec ls -la {} \;
=======
>>>>>>> origin/feature/podcast-system

    - name: Deploy podcast to GitHub Pages
      if: success()
      uses: peaceiris/actions-gh-pages@v4.0.0
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        publish_branch: gh-pages
        keep_files: true # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼ˆãƒ¡ã‚¤ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿è­·ï¼‰
        destination_dir: . # ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ‡ãƒ—ãƒ­ã‚¤
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy daily podcast: ${{ github.run_id }}'
    
<<<<<<< HEAD
    - name: Verify podcast generation before deployment
      if: success()
      run: |
        echo "=== ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆç”Ÿæˆæ¤œè¨¼ï¼ˆé…ä¿¡å‰ï¼‰ ==="
        
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã‚’å¼·åŒ–
        CRITICAL_ERRORS=0
        
        # RSS ãƒ•ã‚£ãƒ¼ãƒ‰ã®å­˜åœ¨ã¨å†…å®¹ã‚’å³æ ¼ãƒã‚§ãƒƒã‚¯
        echo "ğŸ” RSS ãƒ•ã‚£ãƒ¼ãƒ‰æ¤œè¨¼"
        RSS_FILES=("podcast/feed.xml" "podcast/podcast.rss")
        RSS_VALID=0
        
        for rss_file in "${RSS_FILES[@]}"; do
          if [ -f "$rss_file" ]; then
            echo "âœ… RSS ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨: $rss_file"
            
            # RSSå†…å®¹ã®è©³ç´°æ¤œè¨¼
            if grep -q "<rss" "$rss_file" && grep -q "<channel>" "$rss_file"; then
              echo "  âœ… RSS å½¢å¼: æ­£å¸¸"
              
              # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆå›ºæœ‰è¦ç´ ã®æ¤œè¨¼
              if grep -q "itunes:" "$rss_file" || grep -q "podcast:" "$rss_file"; then
                echo "  âœ… ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ‹¡å¼µ: æ¤œå‡º"
                RSS_VALID=1
              else
                echo "  âŒ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ‹¡å¼µ: æœªæ¤œå‡ºï¼ˆiTunes/podcastè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„ï¼‰"
                CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
              fi
              
              # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ç¢ºèª
              episode_count=$(grep -c "<item>" "$rss_file" || echo "0")
              if [ "$episode_count" -gt 0 ]; then
                echo "  âœ… ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: $episode_count"
              else
                echo "  âŒ ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: 0ï¼ˆã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„ï¼‰"
                CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
              fi
              
            else
              echo "  âŒ RSS å½¢å¼: ä¸æ­£ï¼ˆåŸºæœ¬çš„ãªRSSè¦ç´ ãŒä¸è¶³ï¼‰"
              CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
            fi
            break
          else
            echo "âš ï¸ RSS ãƒ•ã‚¡ã‚¤ãƒ«æœªç™ºè¦‹: $rss_file"
          fi
        done
        
        if [ $RSS_VALID -eq 0 ]; then
          echo "âŒ CRITICAL: æœ‰åŠ¹ãªRSSãƒ•ã‚£ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
        fi
        
        # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨æ¤œè¨¼
        echo "ğŸ” éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼"
        AUDIO_COUNT=0
        for audio_file in output/podcast/*.mp3 podcast/*.mp3; do
          if [ -f "$audio_file" ]; then
            file_size=$(stat -c%s "$audio_file" 2>/dev/null || echo "0")
            if [ "$file_size" -gt 10000 ]; then  # 10KBä»¥ä¸Šï¼ˆç©ºãƒ•ã‚¡ã‚¤ãƒ«é™¤å¤–ï¼‰
              echo "âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: $audio_file ($(du -h "$audio_file" | cut -f1))"
              AUDIO_COUNT=$((AUDIO_COUNT + 1))
            else
              echo "âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç•°å¸¸: $audio_file (ã‚µã‚¤ã‚º: ${file_size}ãƒã‚¤ãƒˆ - å°ã•ã™ãã‚‹)"
              CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
            fi
          fi
        done
        
        if [ $AUDIO_COUNT -eq 0 ]; then
          echo "âŒ CRITICAL: æœ‰åŠ¹ãªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
        fi
        
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªindex.htmlã®å­˜åœ¨ç¢ºèª
        echo "ğŸ” ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªindex.htmlæ¤œè¨¼"
        if [ -f "podcast/index.html" ]; then
          echo "âœ… ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªindex.html: å­˜åœ¨"
          # HTMLã®åŸºæœ¬æ§‹é€ ç¢ºèª
          if grep -q "<html" "podcast/index.html" && grep -q "<title>" "podcast/index.html"; then
            echo "  âœ… HTMLæ§‹é€ : æ­£å¸¸"
          else
            echo "  âš ï¸ HTMLæ§‹é€ : ä¸å®Œå…¨ï¼ˆåŸºæœ¬è¦ç´ ãŒä¸è¶³ï¼‰"
          fi
        else
          echo "âŒ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªindex.html: æœªç”Ÿæˆ"
          CRITICAL_ERRORS=$((CRITICAL_ERRORS + 1))
        fi
        
        # è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯é…ä¿¡ã‚’åœæ­¢
        if [ $CRITICAL_ERRORS -gt 0 ]; then
          echo ""
          echo "ğŸ’¥ è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼æ¤œå‡º: $CRITICAL_ERRORS ä»¶"
          echo "âŒ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡ã¯ä¸­æ­¢ã•ã‚Œã¾ã™"
          echo "ğŸš¨ ã‚¨ãƒ©ãƒ¼ã®æœ¬è³ªã‚’éš ã™ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã¯å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“"
          echo "ğŸ“‹ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®:"
          echo "   - RSS ãƒ•ã‚£ãƒ¼ãƒ‰ç”Ÿæˆã®ç¢ºèªï¼ˆfeedgen[podcast]æ‹¡å¼µã®å‹•ä½œç¢ºèªï¼‰"
          echo "   - éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºèª"
          echo "   - GitHub Pages Publisher ã®å‹•ä½œç¢ºèª"
          echo ""
          exit 1
        else
          echo ""
          echo "âœ… ã™ã¹ã¦ã®äº‹å‰æ¤œè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "ğŸ“¡ é…ä¿¡æº–å‚™å®Œäº†"
        fi

    - name: Verify deployed podcast accessibility
      if: success()
      run: |
        echo "=== ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡æ¤œè¨¼ï¼ˆé…ä¿¡å¾Œï¼‰ ==="
=======
    - name: Verify deployed podcast accessibility
      if: success()
      run: |
        echo "=== ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆé…ä¿¡æ¤œè¨¼ ==="
>>>>>>> origin/feature/podcast-system
        
        # GitHub Pages URLæ§‹ç¯‰ï¼ˆãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰
        REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
        REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
        GITHUB_PAGES_BASE="https://${REPO_OWNER}.github.io/${REPO_NAME}"
        
        echo "GitHub Pages ãƒ™ãƒ¼ã‚¹URL: $GITHUB_PAGES_BASE"
        echo "é…ä¿¡æ¤œè¨¼ç”¨URL: $GITHUB_PAGES_BASE/podcast/"
        
        # å°‘ã—å¾…æ©Ÿï¼ˆGitHub Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤åæ˜ ã‚’å¾…ã¤ï¼‰
        echo "GitHub Pagesåæ˜ å¾…æ©Ÿä¸­ï¼ˆ30ç§’ï¼‰..."
        sleep 30
        
        # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        VERIFICATION_FAILED=0
        
        for audio_file in public/podcast/*.mp3; do
          if [ -f "$audio_file" ]; then
            # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
            filename=$(basename "$audio_file")
            audio_url="${GITHUB_PAGES_BASE}/podcast/${filename}"
            
            echo "æ¤œè¨¼ä¸­: $audio_url"
            
            # curlã§HTTPå¿œç­”ç¢ºèªï¼ˆæœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤ï¼‰
            for attempt in {1..3}; do
              if curl -fsSL --head "$audio_url" >/dev/null 2>&1; then
                echo "âœ… ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½: $audio_url (è©¦è¡Œ $attempt)"
                break
              else
                echo "âš ï¸ ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: $audio_url (è©¦è¡Œ $attempt/3)"
                if [ $attempt -eq 3 ]; then
                  echo "âŒ ã‚¢ã‚¯ã‚»ã‚¹ä¸èƒ½: $audio_url"
                  VERIFICATION_FAILED=$((VERIFICATION_FAILED + 1))
                fi
                sleep 10
              fi
            done
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç¢ºèª
            if curl -fsSL --head "$audio_url" 2>/dev/null | grep -i content-length; then
              size=$(curl -fsSL --head "$audio_url" 2>/dev/null | grep -i content-length | cut -d' ' -f2 | tr -d '\r')
              size_mb=$(echo "scale=2; $size / 1024 / 1024" | bc 2>/dev/null || echo "ä¸æ˜")
              echo "  ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: ${size_mb}MB"
            fi
          fi
        done
        
        # RSS ãƒ•ã‚£ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆçµ±ä¸€å¾Œã®feed.xmlã‚’å„ªå…ˆï¼‰
        RSS_URLS=("$GITHUB_PAGES_BASE/podcast/feed.xml" "$GITHUB_PAGES_BASE/feed.xml" "$GITHUB_PAGES_BASE/podcast/podcast.rss")
        RSS_FOUND=0
        RSS_FINAL_URL=""
        
        for rss_url in "${RSS_URLS[@]}"; do
          if curl -fsSL --head "$rss_url" >/dev/null 2>&1; then
            echo "âœ… RSS ãƒ•ã‚£ãƒ¼ãƒ‰ç¢ºèª: $rss_url"
            RSS_FOUND=1
            RSS_FINAL_URL="$rss_url"
            
            # RSSå†…å®¹ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
            if curl -fsSL "$rss_url" | grep -q "<rss"; then
              echo "  RSSå½¢å¼: æ­£å¸¸"
              
              # ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°ç¢ºèª
              episode_count=$(curl -fsSL "$rss_url" | grep -c "<item>" || echo "0")
              echo "  ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰æ•°: $episode_count"
<<<<<<< HEAD
              
              # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ‹¡å¼µã®ç¢ºèª
              if curl -fsSL "$rss_url" | grep -q "itunes:"; then
                echo "  ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ‹¡å¼µ: æ­£å¸¸"
              else
                echo "  âš ï¸ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆæ‹¡å¼µ: æœªæ¤œå‡º"
              fi
            else
              echo "  âš ï¸ RSSå½¢å¼: ä¸æ­£"
              VERIFICATION_FAILED=$((VERIFICATION_FAILED + 1))
=======
            else
              echo "  âš ï¸ RSSå½¢å¼: ä¸æ­£"
>>>>>>> origin/feature/podcast-system
            fi
            break
          fi
        done
        
        if [ $RSS_FOUND -eq 0 ]; then
          echo "âŒ RSS ãƒ•ã‚£ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          VERIFICATION_FAILED=$((VERIFICATION_FAILED + 1))
        fi
        
<<<<<<< HEAD
        # ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®index.htmlç¢ºèª
        INDEX_URL="$GITHUB_PAGES_BASE/podcast/"
        if curl -fsSL --head "$INDEX_URL" >/dev/null 2>&1; then
          echo "âœ… ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ ($INDEX_URL)"
        else
          echo "âŒ ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ã‚¢ã‚¯ã‚»ã‚¹ä¸èƒ½ ($INDEX_URL)"
          VERIFICATION_FAILED=$((VERIFICATION_FAILED + 1))
        fi
        
=======
>>>>>>> origin/feature/podcast-system
        # çµæœã‚µãƒãƒªãƒ¼
        echo "=== é…ä¿¡æ¤œè¨¼çµæœ ==="
        if [ $VERIFICATION_FAILED -eq 0 ]; then
          echo "âœ… å…¨ã¦ã®æ¤œè¨¼ãŒæˆåŠŸã—ã¾ã—ãŸ"
          echo "ğŸ“¡ é…ä¿¡URL: $GITHUB_PAGES_BASE/podcast/"
          if [ -n "$RSS_FINAL_URL" ]; then
            echo "ğŸ“„ RSS URL: $RSS_FINAL_URL"
          fi
        else
          echo "âŒ $VERIFICATION_FAILED ä»¶ã®æ¤œè¨¼å¤±æ•—ãŒã‚ã‚Šã¾ã™"
<<<<<<< HEAD
          echo "âš ï¸ é…ä¿¡ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          echo "ğŸ“¡ æƒ³å®šé…ä¿¡URL: $GITHUB_PAGES_BASE/podcast/"
          # é…ä¿¡å¾Œã®æ¤œè¨¼å¤±æ•—ã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼ˆé…ä¿¡ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹ãŸã‚ï¼‰
=======
          echo "GitHub Pagesã®åæ˜ ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™"
          echo "ğŸ“¡ æƒ³å®šé…ä¿¡URL: $GITHUB_PAGES_BASE/podcast/"
>>>>>>> origin/feature/podcast-system
        fi

    - name: Cleanup temporary files
      if: always()
      run: |
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¿æŒï¼‰
        rm -rf public/
        rm -f temp_podcast_script.txt
        echo "Temporary files cleaned up (audio files preserved for debugging)"

    - name: Workflow summary
      if: always()
      run: |
        echo "## ğŸ“Š Podcast Broadcast Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
<<<<<<< HEAD
        echo "- **Use DB Artifact**: ${{ github.event.inputs.use_db_artifact || 'N/A (scheduled)' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Final Data Source**: ${{ steps.final-source.outputs.final_source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Available**: ${{ steps.artifact-status.outputs.artifact_available }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Database Valid**: ${{ steps.validate-db.outputs.db_valid }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Force Run**: ${{ github.event.inputs.force_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Mode**: ${{ github.event.inputs.test_mode || 'false' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Script Only Mode**: ${{ github.event.inputs.script_only || 'false' }}" >> $GITHUB_STEP_SUMMARY
=======
        echo "- **Execution Mode**: ${{ github.event.inputs.execution_mode || 'production' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Data Source Preference**: ${{ github.event.inputs.data_source || 'auto' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Prompt Pattern**: ${{ github.event.inputs.prompt_pattern || 'current_professional' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Final Data Source**: ${{ steps.final-source.outputs.final_source }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact Available**: ${{ steps.artifact-status.outputs.artifact_available }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Database Valid**: ${{ steps.validate-db.outputs.db_valid }}" >> $GITHUB_STEP_SUMMARY
>>>>>>> origin/feature/podcast-system
        
        # å°æœ¬æƒ…å ±ã‚’è¿½åŠ ï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ Script Analysis Results" >> $GITHUB_STEP_SUMMARY
        
        # å°æœ¬ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
        SCRIPT_SUMMARY_FOUND=0
        for script_file in output/podcast/*_script.txt; do
          if [ -f "$script_file" ]; then
            CHAR_COUNT=$(wc -c < "$script_file")
            LINE_COUNT=$(wc -l < "$script_file")
            FILE_SIZE=$(du -h "$script_file" | cut -f1)
            
            echo "- **Script File**: âœ… $(basename "$script_file")" >> $GITHUB_STEP_SUMMARY
            echo "- **Character Count**: $CHAR_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Line Count**: $LINE_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **File Size**: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
            
            # å°æœ¬ã®æœ€åˆã®200æ–‡å­—ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆGeminièª¬æ˜æ–‡ãƒã‚§ãƒƒã‚¯è¾¼ã¿ï¼‰
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ“„ Script Preview (First 200 characters)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -c 200 "$script_file" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "..." >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            
            # å°æœ¬å“è³ªãƒã‚§ãƒƒã‚¯çµæœã®è¡¨ç¤ºï¼ˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆï¼‰
            metadata_file="${script_file%_script.txt}_script_metadata.json"
            if [ -f "$metadata_file" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ğŸ” Script Quality Check" >> $GITHUB_STEP_SUMMARY
              
              # ä¸é©åˆ‡æ–‡è¨€æ¤œå‡ºçµæœ
              inappropriate_found=$(jq -r '.inappropriate_content.found // false' "$metadata_file" 2>/dev/null || echo "false")
              if [ "$inappropriate_found" == "true" ]; then
                inappropriate_issues=$(jq -r '.inappropriate_content.issues[]?' "$metadata_file" 2>/dev/null | head -3)
                echo "- **âš ï¸ Inappropriate Content**: Found" >> $GITHUB_STEP_SUMMARY
                echo "  - Issues: $inappropriate_issues" >> $GITHUB_STEP_SUMMARY
              else
                echo "- **âœ… Content Check**: Clean" >> $GITHUB_STEP_SUMMARY
              fi
              
              # æ§‹é€ æ¤œè¨¼çµæœ
              structure_valid=$(jq -r '.structure_validation.valid // false' "$metadata_file" 2>/dev/null || echo "false") 
              if [ "$structure_valid" == "true" ]; then
                echo "- **âœ… Structure**: Valid (Opening/Main/Closing)" >> $GITHUB_STEP_SUMMARY
              else
                structure_issues=$(jq -r '.structure_validation.issues[]?' "$metadata_file" 2>/dev/null | head -3)
                echo "- **âš ï¸ Structure**: Issues found" >> $GITHUB_STEP_SUMMARY
                echo "  - Issues: $structure_issues" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            SCRIPT_SUMMARY_FOUND=1
            break
          fi
        done
        
        if [ $SCRIPT_SUMMARY_FOUND -eq 0 ]; then
          echo "- **Script File**: âŒ Not found" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Script generation may have failed" >> $GITHUB_STEP_SUMMARY
        fi
        
        # ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆ
        AUDIO_FOUND=0
        for audio_file in output/podcast/*.mp3 podcast/*.mp3; do
          if [ -f "$audio_file" ]; then
            file_size=$(du -h "$audio_file" | cut -f1)
            file_size_bytes=$(stat -f%z "$audio_file" 2>/dev/null || stat -c%s "$audio_file" 2>/dev/null || echo "unknown")
            
            echo "- **Podcast Generated**: âœ… Yes ($audio_file)" >> $GITHUB_STEP_SUMMARY
            echo "- **File Size**: $file_size ($file_size_bytes bytes)" >> $GITHUB_STEP_SUMMARY
            
            # éŸ³å£°é•·ã•æƒ…å ±ï¼ˆffprobeãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
            if command -v ffprobe >/dev/null 2>&1; then
              duration=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$audio_file" 2>/dev/null | cut -d. -f1)
              if [ -n "$duration" ] && [ "$duration" != "" ]; then
                minutes=$((duration / 60))
                seconds=$((duration % 60))
                echo "- **Audio Duration**: ${minutes}:$(printf %02d $seconds)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # å“è³ªãƒ¬ãƒãƒ¼ãƒˆæƒ…å ±
            quality_report="${audio_file%.*}.quality_report.json"
            if [ -f "$quality_report" ]; then
              echo "- **Quality Report**: âœ… Available" >> $GITHUB_STEP_SUMMARY
              
              # å“è³ªã®æ¦‚è¦ï¼ˆJSONã‹ã‚‰æŠ½å‡ºï¼‰
              if command -v python3 >/dev/null 2>&1; then
                quality_summary=$(python3 -c "import json; data=json.load(open('$quality_report')); print(f'Valid: {data.get(\"valid\",False)}, Duration: {data.get(\"duration_seconds\",0):.1f}s, Issues: {len(data.get(\"issues\",[]))}')" 2>/dev/null || echo "Parse failed")
                if [ -n "$quality_summary" ] && [ "$quality_summary" != "Parse failed" ]; then
                  echo "- **Quality Summary**: $quality_summary" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "- **Quality Report**: âŒ Not found" >> $GITHUB_STEP_SUMMARY
            fi
            
            AUDIO_FOUND=1
            break
          fi
        done
        
        if [ $AUDIO_FOUND -eq 0 ]; then
          echo "- **Podcast Generated**: âŒ No audio files found" >> $GITHUB_STEP_SUMMARY
        fi
        
        # é…ä¿¡URLæƒ…å ±ã‚’è¿½åŠ 
        REPO_OWNER=$(echo ${{ github.repository }} | cut -d'/' -f1)
        REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
        GITHUB_PAGES_BASE="https://${REPO_OWNER}.github.io/${REPO_NAME}"
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¡ é…ä¿¡æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **é…ä¿¡ãƒ™ãƒ¼ã‚¹URL**: $GITHUB_PAGES_BASE/podcast/" >> $GITHUB_STEP_SUMMARY
        echo "- **RSSãƒ•ã‚£ãƒ¼ãƒ‰**: $GITHUB_PAGES_BASE/podcast/feed.xml" >> $GITHUB_STEP_SUMMARY
        echo "- **é…ä¿¡ãƒ–ãƒ©ãƒ³ãƒ**: gh-pages" >> $GITHUB_STEP_SUMMARY

    - name: Collect error details
      if: failure()
      run: |
        echo "Error occurred at: $(date -u)"
        echo "Python version: $(python --version)"
        pip list | grep -E "(google|pydub|feedgen|yaml)" || echo "Missing critical packages"

    - name: Create Issue on Failure
      if: failure() && github.event.pull_request == null
      uses: jayqi/failed-build-issue-action@v1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        title-template: "ğŸ™ï¸ Podcast Broadcast Failed #${{ github.run_number }}"
        body-template: |
          ## Podcast Broadcast Failure
          
          **Run ID**: ${{ github.run_id }}
          **Branch**: ${{ github.ref_name }}
          **Triggered by**: ${{ github.actor }}
          **Time**: ${{ github.event.head_commit.timestamp }}
          
          ### Quick Debug Links
          - [View Failed Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### Common Solutions
          1. Check GitHub Secrets are configured
          2. Verify `GOOGLE_APPLICATION_CREDENTIALS_JSON` is set
          3. Ensure Google Cloud TTS API is enabled
          4. Re-run workflow after checking dependencies
          
          This issue will auto-close when the workflow succeeds.
        label-name: "podcast"
<<<<<<< HEAD
        always-create-new-issue: false
=======
        always-create-new-issue: false
>>>>>>> origin/feature/podcast-system
