# Google Drive ストレージ問題解決プラン（共有ドライブ活用編）

## 1. 背景と目的

現在、プログラムが使用する「サービスアカウント」のGoogle Driveストレージ容量が上限に達し、エラーが発生している。ユーザーはGoogle Oneに加入しており、大容量のストレージを保有している。

この計画の目的は、プログラムのファイルの保存先を、サービスアカウントのストレージから、ユーザーのGoogle Oneストレージが適用される**「共有ドライブ」**に変更することである。これにより、ストレージ容量問題を根本的に解決し、生成されるファイルを削除することなく永続的に保存できる体制を構築する。

## 2. 要件定義

1.  **ストレージ問題の根本解決**:
    *   ファイルの保存先を、サービスアカウント個別のストレージから「共有ドライブ」に変更し、`storageQuotaExceeded`エラーを恒久的に解決する。
2.  **データの永続化**:
    *   プログラムによって生成された日次サマリーファイルを、削除せずに永続的にアーカイブできる体制を構築する。
3.  **最小限のコード変更**:
    *   既存のロジックを可能な限り維持し、共有ドライブへの対応に必要な最小限の変更のみをコードに加える。

## 3. 実行タスクリスト

タスクは、お客様に行っていただく**【手動設定】**と、私（Cline）が行う**【プログラム修正】**の2種類に分かれます。以下のフェーズに従って進めてください。

---

### **フェーズ1: 共有ドライブの準備 【担当：お客様】**

**目的：** プログラムがファイルを保存するための新しい場所（共有ドライブ）を準備します。

| No. | タスク概要 | 詳細手順 |
| :-- | :--- | :--- |
| 1.1 | 共有ドライブの作成 | 1. 個人のGoogleアカウントで [Google Drive](https://drive.google.com/) にアクセスします。<br>2. 左側メニューの「共有ドライブ」を右クリックし、「新しい共有ドライブ」を選択します。<br>3. 任意の名前（例: `Application Archives`）を付けて作成します。 |
| 1.2 | サービスアカウントの招待 | 1. 作成した共有ドライブを右クリックし、「メンバーを管理」を選択します。<br>2. プロジェクト内の `service_account.json` ファイルを開き、`client_email` の値（メールアドレス形式）をコピーします。<br>3. 「ユーザーやグループを追加」の欄にコピーしたメールアドレスを貼り付け、権限を「**コンテンツ管理者**」に設定して「送信」します。 |
| 1.3 | 出力先フォルダの作成とID取得 | 1. 作成した共有ドライブの中に、プログラムが出力するための新しいフォルダを作成します（例: `Market News Summaries`）。<br>2. 作成したフォルダを開き、ブラウザのアドレスバーに表示されるURLの末尾部分をコピーします。これが新しい**フォルダID**です。<br>   (例: `https://drive.google.com/drive/folders/`**`ここに表示される文字列`**) |

**※フェーズ1が完了したら、Clineに作業を依頼してください。**

---

### **フェーズ2: プログラムの共有ドライブ対応 【担当：Cline】**

**目的：** プログラムが共有ドライブを正しく扱えるように修正します。

| No. | 対象ファイル | タスク概要 |
| :-- | :--- | :--- |
| 2.1 | `gdocs/client.py` | **`supportsAllDrives=true`パラメータの追加**<br>Google Drive APIを呼び出している以下の関数内のAPIコールに `supportsAllDrives=true` を追加します。<br> - `test_drive_connection`<br> - `create_daily_summary_doc` |

---

### **フェーズ3: 本番環境への反映 【担当：お客様】**

**目的：** プログラムの出力先を、準備した新しい共有ドライブのフォルダに切り替えます。

| No. | タスク概要 | 詳細手順 |
| :-- | :--- | :--- |
| 3.1 | 環境変数の更新 | **フェーズ2のプログラム修正が完了した後**、以下のいずれかの方法で環境変数を更新します。<br> - **GitHub Actions:** `Settings` > `Secrets and variables` > `Actions` で、`GOOGLE_DRIVE_OUTPUT_FOLDER_ID` の値を、フェーズ1.3で取得した**新しいフォルダID**に更新します。<br> - **ローカル環境:** プロジェクトルートの `.env` ファイルを開き、`GOOGLE_DRIVE_OUTPUT_FOLDER_ID` の値を新しいフォルダIDに書き換えます。 |

## 4. 期待される効果

-   サービスアカウントのストレージ容量制限に起因するエラーが解消される。
-   Google Oneの潤沢なストレージを活用し、生成されたファイルを永続的に保存できる。
-   ファイルの所有者が「チーム（共有ドライブ）」となり、管理が容易になる。
