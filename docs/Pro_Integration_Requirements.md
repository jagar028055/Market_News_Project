# Gemini 2.5 Pro統合要約機能 要件定義書

## 1. 概要

### 1.1 目的
Flash+Pro版の個別記事要約システムに、Gemini 2.5 Proによる統合要約機能を追加し、マーケットニュースの付加価値を向上させる。

### 1.2 背景
- 現状：Flash-Liteによる個別記事要約（200字程度）
- 課題：全体的な市況トレンドや地域間の関連性が把握しにくい
- 解決：Pro版による統合分析で高次元の洞察を提供

### 1.3 対象範囲
- 地域別統合要約機能の実装
- 全体市況要約機能の実装
- HTMLダッシュボードの拡張
- コスト管理機能の追加

## 2. 機能要件

### 2.1 統合要約機能

#### 2.1.1 地域別要約
**概要**: 同一地域の記事群を統合分析
- **入力**: 地域別にグループ化された記事群
- **出力**: 400-600字の地域別市況要約
- **対象地域**: 日本、米国、中国、欧州、その他

**要約内容**:
- 地域内の主要な市場動向
- 重要な経済指標・政策発表
- 企業業績のトレンド
- 地域特有の課題や機会

#### 2.1.2 全体市況要約
**概要**: 全地域の情報を統合した総合分析
- **入力**: 全記事 + 各地域要約
- **出力**: 800-1000字の総合市況レポート

**要約内容**:
- グローバル市場の全体動向
- 地域間の相互影響・波及効果
- 時系列での市場変化
- 今後の注目ポイント・見通し

### 2.2 処理フロー

```
1. Flash-Lite処理 (既存)
   ↓ 個別記事要約 + 地域・カテゴリ分類
   
2. 記事グループ化
   ↓ 地域別・カテゴリ別に整理
   
3. Pro統合処理 (新規)
   ↓ 一括処理で地域別要約 + 全体要約
   
4. HTML出力拡張
   ↓ 既存記事一覧 + 統合要約セクション
```

### 2.3 データ構造

#### 2.3.1 統合要約テーブル
```sql
CREATE TABLE integrated_summaries (
    id INTEGER PRIMARY KEY,
    session_id INTEGER,
    summary_type VARCHAR(20), -- 'regional' or 'global'
    region VARCHAR(20),       -- 地域別の場合のみ
    summary_text TEXT,
    articles_count INTEGER,
    created_at TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES scraping_sessions(id)
);
```

#### 2.3.2 JSON出力形式
```json
{
  "global_summary": "800-1000字の全体市況",
  "regional_summaries": {
    "日本": "400-600字の日本市況",
    "米国": "400-600字の米国市況",
    "中国": "400-600字の中国市況",
    "欧州": "400-600字の欧州市況",
    "その他": "400-600字のその他地域"
  },
  "metadata": {
    "total_articles": 45,
    "articles_by_region": {
      "日本": 12,
      "米国": 18,
      "中国": 8,
      "欧州": 5,
      "その他": 2
    }
  }
}
```

## 3. 非機能要件

### 3.1 パフォーマンス
- **Pro処理時間**: 最大3分以内
- **メモリ使用量**: 既存システムの1.5倍以内
- **同時実行**: Pro処理は1プロセスのみ

### 3.2 コスト管理
- **実行頻度制限**: 1日最大3回まで
- **記事数閾値**: 最低10記事以上で実行
- **コスト監視**: 月間使用量上限設定

### 3.3 信頼性
- **エラーハンドリング**: Pro処理失敗時も既存機能は動作
- **フォールバック**: Pro要約なしでもHTML生成可能
- **ログ出力**: 詳細な処理ログとエラー情報

## 4. 技術仕様

### 4.1 使用モデル
- **個別記事**: gemini-2.5-flash-lite（既存）
- **統合要約**: gemini-2.5-pro（新規）

### 4.2 実装ファイル
- `ai_pro_summarizer.py` - Pro統合要約モジュール
- `article_grouper.py` - 記事グループ化ロジック
- `cost_manager.py` - コスト管理機能
- `src/database/models.py` - データベースモデル拡張
- `src/html/template_engine.py` - HTMLテンプレート拡張

### 4.3 設定項目
```python
# Pro統合要約設定
PRO_INTEGRATION_CONFIG = {
    "enabled": True,
    "min_articles_threshold": 10,
    "max_daily_executions": 3,
    "execution_hours": [9, 15, 21],  # JST
    "cost_limit_monthly": 50.0,     # USD
    "timeout_seconds": 180
}
```

## 5. 開発タスク

### Phase 1: 基盤実装 (3-4日)
1. 統合要約用データベーステーブル設計・作成
2. 2.5Pro用統合要約モジュール作成
3. 記事の地域別グループ化ロジック実装
4. Pro版APIコスト管理機能追加

### Phase 2: UI/UX実装 (2-3日)
5. HTMLテンプレートに要約セクション追加
6. CSS/JS での統合要約表示機能
7. レスポンシブデザイン対応

### Phase 3: システム統合 (2-3日)
8. メイン処理フローに統合要約処理を統合
9. エラーハンドリング・フォールバック機能
10. ログ出力・監視機能強化

### Phase 4: テスト・最適化 (2-3日)
11. 統合テストと動作確認
12. パフォーマンス最適化と調整
13. 本番環境デプロイ準備

## 6. 成功指標

### 6.1 機能指標
- 統合要約生成成功率: 95%以上
- Pro処理完了時間: 平均2分以内
- 日次実行成功率: 98%以上

### 6.2 品質指標
- 要約文字数精度: 目標範囲±20%以内
- 地域分類精度: 90%以上
- ユーザーエラー報告: 月間5件以下

### 6.3 コスト指標
- 月間Pro API費用: $50以下
- 費用対効果: 既存システムコストの2倍以内

## 7. リスク管理

### 7.1 技術リスク
- **Pro API制限**: レート制限・障害時の対策
- **メモリ不足**: 大量記事処理時の対策
- **処理時間超過**: タイムアウト設定・分割処理

### 7.2 運用リスク
- **コスト超過**: 月間上限・アラート機能
- **品質低下**: 要約品質監視・人手確認
- **可用性**: フォールバック機能・監視強化

## 8. 今後の拡張

### 8.1 追加機能候補
- 市場予測・トレンド分析
- 投資推奨レポート生成
- 多言語対応（英語要約）
- ポッドキャスト音声生成への連携

### 8.2 データ活用
- 要約品質の学習データ蓄積
- ユーザー行動分析
- A/Bテストによる要約最適化