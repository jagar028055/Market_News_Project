# Googleドキュメント生成条件の最適化計画書

## 1. 背景

Google Driveのストレージ容量問題への対策として、Googleドキュメントの生成・更新処理の実行頻度を制限する、という新しい要件が提示された。

現在のGitHub Actionsは1日3回（JST 7時, 13時, 23時）定時実行されているが、このうち特定の条件下でのみドキュメント処理を行い、それ以外はHTML生成など他の処理のみを実行することで、ストレージ消費のペースを抑制する。

## 2. 要件定義

1.  **実行条件の厳格化**:
    *   Googleドキュメントの生成・更新は、**火曜日から土曜日の日本時間（JST）午前7時台**に実行された場合にのみ行う。
    *   上記以外の時間帯（JST 13時, 23時）や曜日（日曜日、月曜日）に実行された場合は、ドキュメント関連の処理を完全にスキップする。
2.  **処理の効率化**:
    *   ドキュメント処理が不要な場合、関連するAPIコールを一切行わないことで、プログラムの実行時間短縮とAPI使用量の節約を図る。
3.  **実装の責務分離**:
    *   実行条件の判定ロジックはPythonアプリケーション内に実装する。
    *   GitHub Actionsのワークフローファイル (`.github/workflows/main.yml`) は変更せず、責務を分離し、可読性を維持する。

## 3. 実行タスクリスト

| No. | 対象ファイル | タスク概要 | 詳細 |
| :-- | :--- | :--- | :--- |
| 1 | `src/config/app_config.py` | **実行条件判定ロジックの追加** | - `is_document_creation_day_and_time()` という名前のプロパティ（または関数）を新設する。<br>- 内部で現在時刻（UTC）を取得し、`pytz`ライブラリを使用して日本時間（JST）に変換する。<br>- 変換後のJSTが以下の条件を**すべて**満たす場合に `True` を、それ以外は `False` を返すロジックを実装する。<br>  - **時刻**: 午前7時00分 〜 7時59分<br>  - **曜日**: 火曜日, 水曜日, 木曜日, 金曜日, 土曜日 |
| 2 | `src/core/news_processor.py` | **条件に基づく処理の分岐** | - Googleドキュメント関連の処理（`process_google_docs_output`など）を呼び出す箇所で、事前に `config.is_document_creation_day_and_time()` を呼び出す。<br>- 戻り値が `True` の場合のみ、ドキュメント処理を実行する。<br>- `False` の場合は、「ドキュメント生成はスキップされました（実行対象外の日時です）」といった内容のINFOレベルのログを出力し、後続の処理に進む。 |

## 4. 【重要】残存するリスクと推奨事項

本計画は、ドキュメント生成の**頻度を減らす**ことで、ストレージが満杯になるまでの**時間を稼ぐ**対症療法です。このままでは、数ヶ月後あるいは数年後には、再び同じ `storageQuotaExceeded` エラーが発生します。

この問題を**恒久的に解決**するため、以下のいずれかの対策を、今回の修正と**併せて実施すること**を強く推奨します。

*   **推奨案1: 古いファイルの自動削除機能の実装**
    *   最もシンプルかつコストのかからない解決策です。
    *   一定期間（例: 90日）を過ぎた古いドキュメントを自動で削除する機能を追加します。
*   **推奨案2: 所有権の移管**
    *   サービスアカウントが作成したファイルの所有権を、プログラムで自動的にあなたの個人アカウントに移管します。これにより、Google Oneの容量が使われるようになります。（※共有ドライブが使えない場合の次善策）

まずは今回の要件である「実行条件の最適化」を実装しますが、根本解決のために、上記推奨案のいずれかについても、別途ご検討ください。
