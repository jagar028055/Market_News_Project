---
type: project
title: Googleドキュメントへの自動上書き機能の実装
tags: [project/automation, tech/google_api, tech/python, tech/github_actions]
---

# Googleドキュメントへの自動上書き機能の実装：必要な要素と手順

## ✅ ToDoリスト
- [ ] **GCP:** サービスアカウントを作成し、JSONキーをダウンロードする
- [ ] **GCP:** Google Docs APIを有効化する
- [ ] **Google Drive:** 更新対象のGoogleドキュメントを作成し、IDを控える
- [ ] **Google Drive:** ドキュメントの共有設定で、サービスアカウントに「編集者」権限を付与する
- [ ] **GitHub:** リポジトリのSecretsに`GCP_SA_KEY`と`GOOGLE_DOC_ID`を登録する
- [ ] **開発:** Pythonスクリプトにサービスアカウント認証とドキュメント更新ロジックを実装する
- [ ] **開発:** GitHub Actionsのワークフローファイル（.yml）を修正・作成する
- [ ] **テスト:** ワークフローを手動でトリガーし、ドキュメントが正しく更新されるか確認する

## 概要

指定されたGoogleドキュメントの内容を、プログラム（ローカルまたはGitHub Actions）から毎回クリアし、新しいテキストで上書きするための実装手順をまとめたものです。

---

## Part 1: ローカル環境での手動実行

手動でPCから実行する場合の手順です。OAuth認証を利用します。

### 必要な要素リスト

1.  **Google Cloud Platform (GCP) プロジェクト**
2.  **Google Docs API**
3.  **OAuth 2.0 認証情報 (クレデンシャル)**
4.  **対象となるGoogleドキュメントのID**
5.  **プログラミング言語とGoogle APIクライアントライブラリ** (例: Pythonと`google-api-python-client`)
6.  **ニュース要約を生成する既存のプログラム**

### 実装手順とそれぞれの目的

#### ステップ1：GCPプロジェクトの準備とAPIの有効化
(内容は変更なし)

#### ステップ2：認証情報（OAuth 2.0）の作成
(内容は変更なし)

#### ステップ3：プログラミング環境の準備
(内容は変更なし)

#### ステップ4：プログラムの実装
(内容は変更なし)

---

## Part 2: GitHub Actionsによる完全自動更新

既存のニュース取得ワークフローに、Googleドキュメントの自動更新機能を追加する手順です。サーバー上で実行するため、**サービスアカウント認証**を利用します。

### 必要な要素リスト

1.  **Part 1で設定済みのGCPプロジェクトと有効化済みのGoogle Docs API**
2.  **サービスアカウント** とその **秘密鍵 (JSON)**
3.  **更新対象のGoogleドキュメント** とその **ID**
4.  **GitHubリポジトリ** と **Actions Secrets** の設定
5.  **サービスアカウント認証に対応したPythonスクリプト**
6.  **GitHub Actionsワークフローファイル (.yml)**

### 実装手順とそれぞれの目的

#### ステップ1：Google Cloudでのサービスアカウント設定

1.  **サービスアカウントの作成**
    GCPの「IAMと管理」>「サービスアカウント」で新しいサービスアカウントを作成します（例: `github-actions-doc-updater`）。
    > **目的:** プログラム自体にIDを付与し、ユーザーの介在なしにGoogle APIを利用させるため。

2.  **秘密鍵（JSON）の生成**
    作成したサービスアカウントのキー管理画面から、JSON形式の新しい秘密鍵を作成し、ダウンロードします。
    > **目的:** このJSONファイルが、プログラムが正規のサービスアカウントであることを証明するパスワードの役割を果たします。

#### ステップ2：Googleドキュメントの権限設定

1.  **サービスアカウントへの編集権限の付与**
    更新対象のGoogleドキュメントの「共有」設定を開き、作成したサービスアカウントのメールアドレス（`...@...gserviceaccount.com`）を**「編集者」**として追加します。
    > **目的:** サービスアカウントが、この特定のドキュメントを読み書きする権限を得るため。

#### ステップ3：GitHubリポジトリでのSecrets設定

1.  **リポジトリにSecretsを登録**
    GitHubリポジトリの `Settings` > `Secrets and variables` > `Actions` で、以下の2つのシークレットを登録します。
    - `GCP_SA_KEY`: ダウンロードしたサービスアカウントの**JSONファイルの中身全体**を値として設定。
    - `GOOGLE_DOC_ID`: 更新対象ドキュメントのIDを値として設定。
    > **目的:** 機密情報をコードから分離し、ワークフロー内で安全に利用するため。

#### ステップ4：プログラムとワークフローの修正

1.  **Pythonスクリプトの修正**
    既存のスクリプトに、サービスアカウント認証を利用してドキュメントを更新するロジックを追加します。
    > **目的:** GitHub Actionsの環境変数経由で渡された認証情報とドキュメントIDを使い、非対話形式でAPIを呼び出すため。

2.  **GitHub Actionsワークフローファイル（.yml）の修正**
    ニュース取得ステップの後に、Secretsを環境変数としてスクリプトに渡して実行するステップを追加します。
    ```yaml
    - name: Update Google Doc
      run: python your_script_name.py
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        GOOGLE_DOC_ID: ${{ secrets.GOOGLE_DOC_ID }}
    ```
    > **目的:** Secretsの値を環境変数としてPythonスクリプトに渡し、ドキュメント更新処理を実行させるため。

## 補足：注意点

*   **エラーハンドリング：** ネットワークエラーやAPIの制限などで処理が失敗する場合に備え、プログラムには適切なエラーハンドリング（例: `try-except`ブロック）を実装することが推奨されます。
*   **セキュリティ：** ダウンロードした`credentials.json`や、初回実行時に生成される`token.json`、そしてサービスアカウントのJSONキーは、あなたのGoogleアカウントへのアクセス権を持つ非常に重要なファイルです。絶対に他人に共有したり、GitHubのパブリックリポジトリにアップロードしたりしないでください。

---

## 関連ファイル
- [[2025-07-03-Googleドキュメントへの自動上書き機能の実装_必要な要素と手順]]

---

## 変更履歴 (2025年7月8日)

### feat: Googleドキュメントの上書き更新と日次サマリー機能の実装

この変更では、以下の機能が導入されました。

-   **`gdocs/client.py`**: 認証ロジックをサービスアカウントに対応させ、以下の関数を追加しました。
    -   指定されたGoogleドキュメントを記事全文で上書き更新する機能。
    -   AI要約を含む新しい日次Googleドキュメントを作成する機能。
-   **`config.py`**: 上書き更新機能のために `GOOGLE_OVERWRITE_DOC_ID` を追加しました。
-   **`main.py`**: 上書き更新と日次サマリーの両方のGoogleドキュメント機能を利用するように更新しました。
-   **`.github/workflows/daily-news-summary.yml`**: GitHub Actions向けに `GCP_SA_KEY` と `GOOGLE_DOC_ID` を環境変数として渡すように修正し、`GOOGLE_TOKEN_JSON` を削除しました。

これにより、記事全文を含む専用の継続的に更新されるドキュメントと、AI要約を含む日次アーカイブドキュメントの両方が実現されます。
