# Google Cloud TTS 段階的権限付与ガイド

## 🎯 ガイドの目的

**API有効済み**環境での**403エラー**を段階的に解決するための詳細手順書です。

### 対象環境
- ✅ Cloud Text-to-Speech API: 有効済み
- ✅ 認証情報: 設定済み（2381文字）
- ✅ サービスアカウント: `podcast-tts@gemini-api-in-vscode.iam.gserviceaccount.com`
- ❌ **問題**: 403エラー継続発生

## 📋 段階的診断・解決フロー

### 🔧 ステップ1: 包括的診断実行

まず、すべての診断ツールを実行して問題を特定します：

```bash
# 包括的診断ツール実行
python comprehensive_tts_diagnostics.py
```

**期待される出力**:
- 5つの診断テストが実行される
- 重大な問題が特定される
- 具体的な解決手順が提示される

### 🔧 ステップ2: プロジェクト基本設定確認

#### 2.1 プロジェクト請求設定の確認

1. **Google Cloud Console 請求設定画面**を開く:
   ```
   https://console.cloud.google.com/billing?project=1072034849655
   ```

2. **請求ステータス確認**:
   - ✅ 請求が有効化されている
   - ✅ 有効な支払い方法が設定されている
   - ✅ 請求アカウントがプロジェクトに関連付けられている

3. **問題がある場合の対処**:
   - 請求アカウントを作成
   - 支払い方法を追加
   - プロジェクトに請求アカウントを関連付け

#### 2.2 API有効化の再確認

1. **API ライブラリ画面**を開く:
   ```
   https://console.cloud.google.com/apis/library?project=1072034849655
   ```

2. **Text-to-Speech API 検索**:
   - 検索バーに「text-to-speech」と入力
   - "Cloud Text-to-Speech API" をクリック

3. **ステータス確認**:
   - **「有効」**と表示されることを確認
   - 有効でない場合は **「有効にする」** をクリック

### 🔧 ステップ3: サービスアカウント権限設定

#### 3.1 IAM 権限画面での確認

1. **IAM管理画面**を開く:
   ```
   https://console.cloud.google.com/iam-admin/iam?project=1072034849655
   ```

2. **サービスアカウント検索**:
   - 検索バーに `podcast-tts@gemini-api-in-vscode.iam.gserviceaccount.com` を入力
   - または「podcast-tts」で検索

3. **現在の権限確認**:
   - サービスアカウント名をクリック
   - 「権限」タブで現在の役割を確認

#### 3.2 必要権限の付与

**最小権限アプローチ** (推奨):

1. **Cloud Text-to-Speech User** 権限を付与:
   - サービスアカウント横の **「権限を編集」** をクリック
   - **「別のロールを追加」** をクリック
   - `Cloud Text-to-Speech User` を検索・選択
   - **「保存」** をクリック

**包括的権限アプローチ** (トラブルシューティング用):

1. **Editor** 権限を付与 (一時的):
   - 同様の手順で `Editor` 役割を付与
   - 動作確認後、最小権限に戻す

#### 3.3 サービスアカウント状態の確認

1. **サービスアカウント画面**を開く:
   ```
   https://console.cloud.google.com/iam-admin/serviceaccounts?project=1072034849655
   ```

2. **アカウント詳細確認**:
   - `podcast-tts@gemini-api-in-vscode.iam.gserviceaccount.com` をクリック
   - **「詳細」** タブで状態確認
   - **無効化されている場合**: 「有効にする」をクリック

### 🔧 ステップ4: 認証キーの検証・更新

#### 4.1 既存キーの確認

1. サービスアカウント詳細画面の **「キー」** タブをクリック
2. 現在のキーの作成日時を確認
3. 古いキー（90日以上）は削除を検討

#### 4.2 新しいキーの生成（必要な場合のみ）

1. **「キーを追加」** → **「新しいキーを作成」** をクリック
2. **JSON** 形式を選択
3. 生成されたJSONファイルをダウンロード
4. **GitHub Secrets** の `GOOGLE_APPLICATION_CREDENTIALS_JSON` を更新

**⚠️ 注意**: キー更新は最後の手段として実行してください。

### 🔧 ステップ5: 段階的テスト実行

#### 5.1 ローカル権限テスト

```bash
# サービスアカウント権限詳細診断
python diagnose_service_account_permissions.py
```

**成功条件**:
- ✅ 基本認証成功
- ✅ 音声一覧取得成功
- ✅ 音声合成成功

#### 5.2 プロジェクト設定テスト

```bash
# プロジェクト設定詳細診断
python diagnose_project_settings.py
```

**成功条件**:
- ✅ 請求設定有効
- ✅ API有効化確認
- ✅ TTS API呼び出し成功

#### 5.3 GitHub Actions テスト

```bash
# GitHub Actions でのテスト実行
gh workflow run "Daily Podcast Broadcast" --ref feature/google-cloud-tts-test -f test_mode=true -f force_run=true
```

**成功条件**:
- ❌ 403エラーが発生しない
- ✅ `セグメント合成成功` ログが出力
- ✅ 実際の音声ファイルが生成（80KB以上）

## 🚨 トラブルシューティング

### 問題パターン別対処法

#### パターン1: 請求設定問題
**症状**: `billing account` エラー
**対処**: 
1. プロジェクトで請求を有効化
2. 有効な支払い方法を設定
3. 請求アカウントをプロジェクトに関連付け

#### パターン2: 権限不足
**症状**: `permission denied` エラー
**対処**:
1. サービスアカウントに `Cloud Text-to-Speech User` 権限を付与
2. サービスアカウントが無効化されていないことを確認
3. 必要に応じて `Editor` 権限で動作確認

#### パターン3: API制限
**症状**: `quota exceeded` エラー
**対処**:
1. API クォータ制限画面で使用量確認
2. 制限の引き上げリクエスト
3. 使用頻度の調整

#### パターン4: ネットワーク・環境問題
**症状**: 間欠的な403エラー
**対処**:
1. 異なる時間帯での再実行
2. GitHub Actions環境変数の確認
3. 一時的な制限の解除待ち

## 📊 成功確認チェックリスト

### ✅ 最終確認項目

- [ ] **プロジェクト設定**:
  - [ ] 請求が有効化されている
  - [ ] Text-to-Speech API が有効
  - [ ] プロジェクトIDが正しい（1072034849655）

- [ ] **サービスアカウント設定**:
  - [ ] アカウントが有効状態
  - [ ] `Cloud Text-to-Speech User` 権限が付与
  - [ ] 認証キーが有効

- [ ] **動作確認**:
  - [ ] ローカル診断ツールで全テスト成功
  - [ ] GitHub Actions で403エラーなし
  - [ ] 実際の音声ファイル生成

## 🎯 完了判定

すべての確認項目で ✅ が付いた場合、**Issue #4 解決完了** とします。

### 解決後の推奨作業

1. **本格運用移行**:
   - `PODCAST_TEST_MODE=false` での動作確認
   - 定期実行スケジュールの有効化

2. **監視設定**:
   - コスト監視アラート設定
   - エラー通知機能の有効化

3. **ドキュメント更新**:
   - 解決手順の記録
   - 運用マニュアルの更新

---

**作成日**: 2025-08-19  
**対象**: Issue #4 (ポッドキャスト配信ワークフロー失敗)  
**環境**: feature/google-cloud-tts-test ブランチ