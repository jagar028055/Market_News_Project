# Google Drive ストレージ容量問題 解決計画書

## 1. 問題の概要

GitHub Actionsの実行ログから、Google Drive APIが`403 Forbidden (storageQuotaExceeded)`エラーを返していることが確認された。これは、プログラムがGoogle Driveに日次サマリーファイルを毎日新規作成し続けた結果、サービスアカウントに割り当てられたストレージ容量の上限に達したことが原因である。

現在の実装 (`gdocs/client.py`の`create_daily_summary_doc`関数) は、日付ごとに新しいGoogleドキュメントを作成するため、時間経過とともにファイルが蓄積し、ストレージを圧迫する。

## 2. 解決方針

根本的な解決策として、**古い日次サマリーファイルを自動的に削除する機能**をアプリケーションに実装する。これにより、手動でのメンテナンスを不要にし、将来的なストレージ容量問題を恒久的に解決する。

## 3. 要件定義

1.  **ストレージの自動管理**:
    *   Google Drive内に蓄積された古いサマリーファイルを、プログラム実行時に自動で削除する。
2.  **設定の柔軟性**:
    *   ファイルの保持期間を環境変数で設定可能にし、運用状況に応じて柔軟に変更できるようにする。
3.  **安全な運用**:
    *   削除対象となるファイルの条件を明確に定義する（命名規則と日付）。
    *   どのファイルが削除されたかをログに記録し、処理の透明性を確保する。

## 4. タスクリスト

| No. | ファイル | タスク概要 | 詳細 |
| :-- | :--- | :--- | :--- |
| 1 | `src/config/app_config.py` | ファイル保持期間の設定追加 | 環境変数 `GOOGLE_DRIVE_RETENTION_DAYS` から、サマリーファイルの保持期間（日数）を読み込む設定を追加する。デフォルト値は `30` 日とする。 |
| 2 | `gdocs/client.py` | 古いファイル削除機能の実装 | `delete_old_summary_docs` 関数を新規作成する。<br> - 指定されたフォルダIDと保持期間を基に、命名規則 (`_Market_News_AI_Summary`) に一致するファイルを検索。<br> - ファイル名から日付を解析し、保持期間を超えたものを特定。<br> - Drive API (`files().delete()`) を使用してファイルを削除。<br> - 処理の開始、対象ファイルのリスト、削除結果をログに出力する。 |
| 3 | `src/core/news_processor.py` | 削除機能の呼び出し | メイン処理 (`run` 関数) の開始時に、`app_config` から保持期間を取得し、`gdocs.client.delete_old_summary_docs` 関数を呼び出す。これにより、新しいファイルを作成する前にストレージ容量を確保する。 |

## 5. 実装後の期待効果

-   Google Driveのストレージ容量が自動的に管理され、`storageQuotaExceeded`エラーが解消される。
-   手動でファイルを削除する運用コストがゼロになる。
-   システムの長期的な安定稼働が実現される。

---
*補足: 先に検討したGitHub Actionsワークフローの改善 (`RELIABILITY_IMPROVEMENT_PLAN.md`) は、今回のエラーの直接的な原因ではないが、システムの効率性と信頼性を高めるために別途実施を推奨する。*
